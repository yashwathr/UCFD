<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cable Fault Dashboard — Static Image BG</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  :root {
    /* Vibrant Color Palette */
    --bg: #020617; /* Very dark blue */
    --card-bg: rgba(15, 23, 42, 0.5); /* Semi-transparent dark blue */
    --border: rgba(255, 255, 255, 0.1);
    --shadow: rgba(0, 0, 0, 0.2);
    
    --accent: #38BDF8; /* Sky Blue */
    --good: #4ADE80; /* Bright Green */
    --bad: #F87171; /* Bright Red */
    --warn: #FACC15; /* Bright Yellow */
    --teal: #5eead4; /* Added for gradients */
    
    /* Variables for themed glows */
    --accent-glow: rgba(56, 189, 248, 0.1);
    --good-glow: rgba(74, 222, 128, 0.1);
    --bad-glow: rgba(248, 113, 113, 0.1);
    --warn-glow: rgba(250, 204, 21, 0.1);

    --text: #E2E8F0; /* Light Gray */
    --muted: #94A3B8; /* Medium Gray */
  }
  
  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', Arial, Helvetica, sans-serif;
    background-color: var(--bg);
    
    /* MODIFIED: Replaced gradients with a still image.
      Replace this URL with your own image! 
    */
    background-image: url('https://images.unsplash.com/photo-1579548122080-c35fd6820ecb?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=1170,abstract,technology,blur');
    
    /* Ensure the image covers the screen and stays fixed */
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    background-attachment: fixed; /* Keep image fixed during scroll */

    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* REMOVED @keyframes moveGradient */
  
  /* Glassmorphism Header */
  header {
    padding: 12px 24px;
    /* Base glass + subtle sheen */
    background-image: 
      linear-gradient(90deg, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.4)), 
      radial-gradient(circle at 10% 50%, rgba(255, 255, 255, 0.08), transparent 70%);
    backdrop-filter: blur(12px); /* The "frost" */
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .brand {
    display: flex;
    gap: 16px;
    align-items: center;
  }
  
  .logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #1E3A8A);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFF;
    font-weight: 700;
    font-size: 1.1rem;
    flex-shrink: 0;
  }
  
  .header-title {
    font-size: 1.4rem;
    font-weight: 500;
    color: var(--text);
  }
  
  .wrap {
    max-width: 1200px;
    margin: 24px auto;
    padding: 0 24px;
  }
  
  .indicators {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-shrink: 0;
  }
  
  .pill {
    background: rgba(255, 255, 255, 0.05); 
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 999px;
    color: var(--muted);
    font-size: 0.85rem;
    font-weight: 500;
    display: inline-flex;
    gap: 8px;
    align-items: center;
  }
  
  .grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }
  
  /* Glassmorphism Card with internal gradient glow */
  .card {
    /* Base glass + internal glow */
    background-image: 
      linear-gradient(135deg, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.3)),
      radial-gradient(circle at top left, var(--card-glow, var(--accent-glow)), transparent 70%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 4px 30px var(--shadow);
    padding: 16px;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.2s ease;
  }
  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 40px var(--shadow);
  }

  /* Themed card glows */
  #volCard  { --card-glow: var(--accent-glow); }
  #curCard  { --card-glow: var(--good-glow); }
  #tempCard { --card-glow: var(--warn-glow); }
  #leakCard { --card-glow: var(--bad-glow); }
  .relay-card { --card-glow: rgba(139, 92, 246, 0.1); } /* Purple glow for relay */

  .row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .left {
    display: flex;
    gap: 16px;
    align-items: center;
  }
  
  /* Gradient Icons */
  .icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #1E3A8A);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFF;
    font-size: 1.2rem;
  }
  #curCard .icon { background: linear-gradient(135deg, var(--good), #166534); }
  #tempCard .icon { background: linear-gradient(135deg, var(--warn), #854D0E); }
  #leakCard .icon { background: linear-gradient(135deg, var(--bad), #991B1B); }

  .title {
    font-size: 0.9rem;
    color: var(--muted);
    font-weight: 500;
  }
  
  .val {
    font-size: 1.75rem;
    font-weight: 500;
    color: var(--text);
    line-height: 1.2;
  }
  
  .unit {
    font-size: 1rem;
    color: var(--muted);
    margin-left: 4px;
  }
  
  /* New "Glow" Fault Animation */
  .fault-fast {
    animation: fault-glow 0.8s ease-in-out 1;
  }
  @keyframes fault-glow {
    0%, 100% {
      border-color: var(--border);
      box-shadow: 0 4px 30px var(--shadow);
    }
    50% {
      border-color: var(--bad);
      box-shadow: 0 0 15px 5px rgba(248, 113, 113, 0.4);
    }
  }

  .relay-card {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
  }
  .relay-status-text {
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Themed Switch */
  .toggle {
    width: 40px;
    height: 22px;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    padding: 3px;
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .knob {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #E2E8F0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    transition: transform 0.22s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateX(0px);
  }
  
  /* Gradient for toggle "on" state */
  .toggle.on {
    background: linear-gradient(90deg, var(--accent), var(--teal));
    border-color: var(--accent);
  }
  
  .toggle.on .knob {
    background: #FFFFFF;
    transform: translateX(18px);
  }
  
  /* Charts area */
  .charts {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-top: 20px;
  }
  
  /* Chart Card with internal gradient glow */
  .chart-card {
    padding: 16px;
    border-radius: 12px;
    /* Base glass + internal glow */
    background-image: 
      linear-gradient(135deg, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.3)),
      radial-gradient(circle at top left, var(--accent-glow), transparent 70%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    box-shadow: 0 4px 30px var(--shadow);
  }
  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .chart-title {
    font-weight: 500;
    font-size: 1rem;
    color: var(--text);
  }
  .chart-subtitle {
    color: var(--muted);
    font-size: 0.85rem;
  }
  
  canvas {
    width: 100% !important;
    height: 220px !important;
  }
  
  footer {
    padding: 24px 6px;
    color: var(--muted);
    text-align: center;
    margin-top: 16px;
    font-size: 0.9rem;
  }
  
  /* -------------------------
     Tablet Breakpoint
     ------------------------- */
  @media (max-width: 980px) {
    .grid { grid-template-columns: repeat(2, 1fr); }
    .charts { grid-template-columns: 1fr; }
  }
  
  /* -------------------------
     Smartphone Breakpoint (OPTIMIZED)
     ------------------------- */
  @media (max-width: 560px) {
    .grid { grid-template-columns: 1fr; }
    .charts { grid-template-columns: 1fr; }
    canvas { height: 180px !important; }
    
    /* Header optimization */
    header { 
      flex-direction: column; 
      gap: 12px; 
      padding: 16px 12px; 
      align-items: center; /* Center stacked items */
    }
    .header-title { font-size: 1.2rem; }
    .indicators { 
      flex-wrap: wrap; /* Allow pills to wrap */
      justify-content: center; 
    }

    .wrap { margin: 12px auto; padding: 0 12px; }
    .grid, .charts { gap: 12px; }
    .charts { margin-top: 12px; }
    
    /* Card text size optimization */
    .val { font-size: 1.6rem; }
    .title { font-size: 0.85rem; }

    /* Relay card layout optimization */
    .relay-card {
      flex-direction: column;
      align-items: flex-start; /* Align text & toggle to the left */
      gap: 12px;
    }
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">EEE</div>
    <div class="header-title">Cable Fault Monitoring</div>
  </div>
  <div class="indicators">
    <div id="conn" class="pill"><i class="fas fa-wifi"></i> Connecting...</div>
    <div id="sys" class.="pill"><i class="fas fa-shield-alt"></i> SYSTEM</div>
  </div>
</header>

<div class="wrap">
  
  <section class="grid" aria-label="sensor-cards">
    <div id="volCard" class="card">
      <div class="row">
        <div class="left">
          <div class="icon"><i class="fas fa-bolt"></i></div>
          <div>
            <div class="title">Voltage</div>
            <div class="val"><span id="volV">--</span><span class="unit">V</span></div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="title">Status</div>
          <div id="volS" style="font-weight:700;color:var(--muted)">NORMAL</div>
        </div>
      </div>
    </div>

    <div id="curCard" class="card">
      <div class="row">
        <div class="left">
          <div class="icon"><i class="fas fa-wave-square"></i></div>
          <div>
            <div class="title">Current</div>
            <div class="val"><span id="curV">--</span><span class="unit">A</span></div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="title">Status</div>
          <div id="curS" style="font-weight:7E00;color:var(--muted)">NORMAL</div>
        </div>
      </div>
    </div>

    <div id="tempCard" class="card">
      <div class="row">
        <div class="left">
          <div class="icon"><i class="fas fa-thermometer-half"></i></div>
          <div>
            <div class="title">Temperature</div>
            <div class="val"><span id="tmpV">--</span><span class="unit">°C</span></div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="title">Status</div>
          <div id="tmpS" style="font-weight:700;color:var(--muted)">NORMAL</div>
        </div>
      </div>
    </div>

    <div id="leakCard" class="card">
      <div class="row">
        <div class="left">
          <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
          <div>
            <div class="title">Leakage</div>
            <div class="val"><span id="lekV">--</span><span class="unit">A</span></div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="title">Status</div>
          <div id="lekS" style="font-weight:700;color:var(--muted)">NORMAL</div>
        </div>
      </div>
    </div>
    
    <div class="card relay-card">
      <div>
        <div class="title">Relay Control</div>
        <div id="relayLabel" class="relay-status-text">CIRCUIT CLOSED</div>
      </div>
      <div id="relay" class="toggle" role="button" tabindex="0" aria-pressed="false" title="Toggle relay">
        <div class="knob"></div>
      </div>
    </div>
  </section>

  <section class="charts">
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Voltage (zoomable)</div>
        <div class="chart-subtitle">pinch / drag / scroll</div>
      </div>
      <canvas id="chartVoltage"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Current (zoomable)</div>
        <div class="chart-subtitle">pinch / drag / scroll</div>
      </div>
      <canvas id="chartCurrent"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Temperature (zoomable)</div>
        <div class="chart-subtitle">pinch / drag / scroll</div>
      </div>
      <canvas id="chartTemp"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Leakage (zoomable)</div>
        <div class="chart-subtitle">pinch / drag / scroll</div>
      </div>
      <canvas id="chartLeak"></canvas>
    </div>
  </section>

  <footer>Tip: pinch to zoom or drag to pan on touch. Mouse wheel works on desktop.</footer>
</div>

<script>
/* -------------------------
  Firebase minimal config
--------------------------*/
const firebaseConfig = {
  databaseURL: "https://cablefaultdetection-77552-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* thresholds */
const TH = { voltage: 10.5, current: 2.8, temp: 60.0, leakage: 0.1 };

/* DOM */
const conn = document.getElementById('conn'), sys = document.getElementById('sys');
const volV = document.getElementById('volV'), curV = document.getElementById('curV'),
      tmpV = document.getElementById('tmpV'), lekV = document.getElementById('lekV');
const volCard = document.getElementById('volCard'), curCard = document.getElementById('curCard'),
      tmpCard = document.getElementById('tempCard'), lekCard = document.getElementById('leakCard');
const volStatus = document.getElementById('volS'), curStatus = document.getElementById('curS'),
      tmpStatus = document.getElementById('tmpS'), lekStatus = document.getElementById('lekS');

const relay = document.getElementById('relay'), relayLabel = document.getElementById('relayLabel');

/* chart history stores (full history) */
const MAX_HISTORY = 300;
const history = {
  voltage: { labels: [], values: [] },
  current: { labels: [], values: [] },
  temp: { labels: [], values: [] },
  leak: { labels: [], values: [] }
};

/* visible window state per chart */
function makeWindowState() {
  return { start: 0, size: 60 }; // show last 60 points by default
}
const windowState = { voltage: makeWindowState(), current: makeWindowState(), temp: makeWindowState(), leak: makeWindowState() };

/* create charts (Updated for Glassmorphism Theme) */
function makeChart(ctx, colorA, colorB) {
  return new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ data: [], borderColor: colorA, backgroundColor: colorB, tension: 0.25, fill: true, pointRadius: 1, borderWidth: 2 }] },
    options: {
      responsive: true,
      animation: { duration: 200 },
      plugins: { legend: { display: false } },
      scales: {
        x: {
          display: true,
          type: 'time',
          time: {
            unit: 'second',
            tooltipFormat: 'T',
            displayFormats: {
              second: 'HH:mm:ss'
            }
          },
          ticks: { color: '#94A3B8' }, 
          grid: { color: 'rgba(255, 255, 255, 0.05)' } 
        },
        y: {
          beginAtZero: true,
          ticks: { color: '#94A3B8' }, 
          grid: { color: 'rgba(255, 255, 255, 0.05)' } 
        }
      }
    }
  });
}

const chVolt = makeChart(document.getElementById('chartVoltage').getContext('2d'), '#38BDF8', 'rgba(56, 189, 248, 0.1)');
const chCurr = makeChart(document.getElementById('chartCurrent').getContext('2d'), '#4ADE80', 'rgba(74, 222, 128, 0.1)');
const chTemp = makeChart(document.getElementById('chartTemp').getContext('2d'), '#FACC15', 'rgba(250, 204, 21, 0.1)');
const chLeak = makeChart(document.getElementById('chartLeak').getContext('2d'), '#F87171', 'rgba(248, 113, 113, 0.1)');

const charts = { voltage: chVolt, current: chCurr, temp: chTemp, leak: chLeak };

/* quick fault visual (Updated for Glassmorphism Theme) */
function quickFaultVisual(cardEl, chart) {
  cardEl.classList.add('fault-fast');
  const canvas = chart.canvas;
  const orig = canvas.style.backgroundColor;
  canvas.style.transition = 'background-color 0.12s linear';
  canvas.style.backgroundColor = 'rgba(248, 113, 113, 0.1)';
  setTimeout(() => { canvas.style.backgroundColor = orig; }, 260);
  setTimeout(() => { cardEl.classList.remove('fault-fast'); }, 800);
}

/* update UI values + charts (Updated for Glassmorphism Theme) */
function applyData(obj) {
  const v = Number(obj.voltage ?? obj.Voltage ?? obj.V ?? 0);
  const c = Number(obj.current ?? obj.Current ?? obj.I ?? 0);
  const t = Number(obj.temperature ?? obj.Temperature ?? obj.temp ?? 0);
  const l = Number(obj.leakage_current ?? obj.leakage ?? obj.Leakage ?? 0);
  const relay = obj.relay_status ?? obj.relay ?? obj.Relay ?? obj.relay_status ?? obj.manual_relay ?? 'CLOSED';
  
  const now = Date.now();

  volV.textContent = v.toFixed(2);
  curV.textContent = c.toFixed(2);
  tmpV.textContent = t.toFixed(1);
  lekV.textContent = l.toFixed(3);

  pushHistory('voltage', now, v);
  pushHistory('current', now, c);
  pushHistory('temp', now, t);
  pushHistory('leak', now, l);
  for (const key of ['voltage', 'current', 'temp', 'leak']) {
    const h = history[key];
    const w = windowState[key];
    const maxStart = Math.max(0, h.labels.length - w.size);
    if (w.start >= maxStart - 1) {
      w.start = Math.max(0, h.labels.length - w.size);
    }
    refreshChartSimple(key);
  }

  if (v < TH.voltage) { setFaultUI(volCard, volStatus, true, 'LOW'); quickFaultVisual(volCard, chVolt); } else setFaultUI(volCard, volStatus, false, 'NORMAL');
  if (c > TH.current) { setFaultUI(curCard, curStatus, true, 'OVER'); quickFaultVisual(curCard, chCurr); } else setFaultUI(curCard, curStatus, false, 'NORMAL');
  if (t > TH.temp) { setFaultUI(tmpCard, tmpStatus, true, 'OVER'); quickFaultVisual(tmpCard, chTemp); } else setFaultUI(tmpCard, tmpStatus, false, 'NORMAL');
  if (l > TH.leakage) { setFaultUI(lekCard, lekStatus, true, 'DETECTED'); quickFaultVisual(lekCard, chLeak); } else setFaultUI(lekCard, lekStatus, false, 'NORMAL');

  const any = (v < TH.voltage) || (c > TH.current) || (t > TH.temp) || (l > TH.leakage);
  sys.innerHTML = any ? '<i class="fas fa-exclamation-triangle"></i> FAULT' : '<i class="fas fa-check-circle"></i> SYSTEM NORMAL';
  sys.style.color = any ? '#F87171' : '#4ADE80';

  const isOpen = (String(relay).toUpperCase() === 'OPEN' || Number(relay) === 1 || String(relay) === '1');
  setRelayUI(isOpen);
}

/* set fault UI text/color (Updated for Glassmorphism Theme) */
function setFaultUI(card, statusEl, isFault, text) {
  if (isFault) {
    card.classList.add('fault');
    statusEl.textContent = text;
    statusEl.style.color = '#F87171';
  } else {
    card.classList.remove('fault');
    statusEl.textContent = 'NORMAL';
    statusEl.style.color = '#94A3B8';
  }
}

/* set relay UI (Updated for Glassmorphism Theme) */
function setRelayUI(on) {
  if (on) {
    relay.classList.add('on');
    relay.setAttribute('aria-pressed', 'true');
    relayLabel.textContent = 'CIRCUIT OPEN';
    relayLabel.style.color = '#38BDF8';
  } else {
    relay.classList.remove('on');
    relay.setAttribute('aria-pressed', 'false');
    relayLabel.textContent = 'CIRCUIT CLOSED';
    relayLabel.style.color = '#94A3B8';
  }
}

/* Firebase connection indicator (Updated for Glassmorphism Theme) */
const connRef = db.ref('.info/connected');
connRef.on('value', s => {
  const v = s.val();
  if (v === true) {
    conn.innerHTML = '<i class="fas fa-wifi"></i> Connected';
    conn.style.color = '#4ADE80';
  } else {
    conn.innerHTML = '<i class="fas fa-wifi"></i> Offline';
    conn.style.color = '#F87171';
  }
}, e => { conn.innerHTML = '<i class="fas fa-wifi"></i> Error'; });


/* =======================================================
  UNCHANGED LOGIC SECTION: All core functionality
  =======================================================
*/

/* helper to push to full history */
function pushHistory(key, label, value) {
  const h = history[key];
  h.labels.push(label);
  h.values.push(value);
  if (h.labels.length > MAX_HISTORY) { h.labels.shift(); h.values.shift(); }
}

/* apply visible window slices to chart and update */
function refreshChartSimple(key) {
  const ch = charts[key];
  const h = history[key];
  const w = windowState[key];
  const maxStart = Math.max(0, h.labels.length - w.size);
  const start = Math.min(Math.max(0, w.start), maxStart);
  const end = Math.min(h.labels.length, start + w.size);
  ch.data.labels = h.labels.slice(start, end);
  ch.data.datasets[0].data = h.values.slice(start, end);
  ch.update('none');
}

/* Write relay to DB */
function writeRelay(on) {
  db.ref('manual_controls/relay_status').set(on ? 'OPEN' : 'CLOSED').catch(e => console.error(e));
  db.ref('relay').set(on ? 1 : 0).catch(e => console.error(e));
}

/* Relay click */
relay.addEventListener('click', () => {
  const currently = relay.classList.contains('on');
  const next = !currently;
  setRelayUI(next);
  writeRelay(next);
});
relay.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); relay.click(); } });


/* Data listener */
function startListeners() {
  const sensorDataRef = db.ref('sensor_data');
  sensorDataRef.once('value', snap => {
    if (snap.exists()) {
      conn.innerHTML = '<i class="fas fa-wifi"></i> Connected (sensor_data)';
      sensorDataRef.on('value', s => { const obj = s.val(); if (!obj) return; const keys = Object.keys(obj); const latestKey = keys.sort().pop(); applyData(obj[latestKey]); }, err => console.error(err));
    } else {
      conn.innerHTML = '<i class="fas fa-wifi"></i> Connected (root)';
      db.ref('voltage').on('value', s => { const val = s.val(); applyData({ voltage: val }); }, e => console.error(e));
      db.ref('current').on('value', s => { applyData({ current: s.val() }); }, e => console.error(e));
      db.ref('temperature').on('value', s => { applyData({ temperature: s.val() }); }, e => console.error(e));
      db.ref('leakage_current').on('value', s => { applyData({ leakage: s.val() }); }, e => console.error(e));
      db.ref('relay').on('value', s => { if (s.exists()) setRelayUI(s.val() === 1); }, e => console.error(e));
    }
  }, err => console.error(err));
}

/* ---------- Custom pinch/drag zoom/pan handlers for each chart ---------- */
function attachZoomPan(canvas, key) {
  let state = { touching: false, startTouches: null, startDist: 0, startWindowSize: windowState[key].size, startWindowStart: windowState[key].start, isPanning: false, lastX: 0 };
  function getDistance(t1, t2) { const dx = t2.clientX - t1.clientX, dy = t2.clientY - t1.clientY; return Math.hypot(dx, dy); }
  function clampWindow() {
    const h = history[key];
    const w = windowState[key];
    if (w.size < 5) w.size = 5;
    if (w.size > Math.max(5, h.labels.length)) w.size = Math.max(5, h.labels.length);
    const maxStart = Math.max(0, h.labels.length - w.size);
    if (w.start < 0) w.start = 0;
    if (w.start > maxStart) w.start = maxStart;
  }
  
  canvas.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
      state.touching = true; state.isPanning = true;
      state.lastX = e.touches[0].clientX;
      state.startWindowStart = windowState[key].start;
    } else if (e.touches.length === 2) {
      state.touching = true; state.isPanning = false;
      state.startDist = getDistance(e.touches[0], e.touches[1]);
      state.startWindowSize = windowState[key].size;
      state.startWindowStart = windowState[key].start;
    }
  }, { passive: true });
  
  canvas.addEventListener('touchmove', e => {
    if (!state.touching) return;
    if (e.touches.length === 1 && state.isPanning) {
      const dx = e.touches[0].clientX - state.lastX;
      state.lastX = e.touches[0].clientX;
      const chartWidth = canvas.clientWidth;
      const h = history[key];
      if (h.labels.length === 0) return;
      const pxPerLabel = chartWidth / Math.max(1, windowState[key].size);
      const labelDelta = Math.round(-dx / pxPerLabel);
      windowState[key].start = state.startWindowStart + labelDelta;
      clampWindow();
      refreshChartSimple(key);
    } else if (e.touches.length === 2) {
      const newDist = getDistance(e.touches[0], e.touches[1]);
      const scale = state.startDist / newDist;
      let newSize = Math.round(state.startWindowSize * scale);
      if (newSize < 5) newSize = 5;
      if (newSize > history[key].labels.length) newSize = history[key].labels.length;
      windowState[key].size = newSize;
      const centerStart = state.startWindowStart + Math.floor(state.startWindowSize / 2);
      windowState[key].start = centerStart - Math.floor(newSize / 2);
      clampWindow();
      refreshChartSimple(key);
    }
    e.preventDefault();
  }, { passive: false });
  
  canvas.addEventListener('touchend', e => {
    state.touching = false; state.isPanning = false;
  });
  
  canvas.addEventListener('wheel', e => {
    e.preventDefault();
    const delta = e.deltaY;
    const w = windowState[key];
    if (delta > 0) w.size = Math.min(Math.max(5, w.size + 4), history[key].labels.length || 200);
    else w.size = Math.max(5, w.size - 4);
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const ratio = mouseX / rect.width;
    const centerIndex = Math.floor(w.start + w.size * ratio);
    w.start = centerIndex - Math.floor(w.size / 2);
    if (w.start < 0) w.start = 0;
    refreshChartSimple(key);
  }, { passive: false });
  
  let mouseDown = false;
  let mdStartX = 0, mdStartWindowStart = 0;
  canvas.addEventListener('mousedown', e => {
    mouseDown = true; mdStartX = e.clientX; mdStartWindowStart = windowState[key].start;
    canvas.style.cursor = 'grabbing';
  });
  window.addEventListener('mousemove', e => {
    if (!mouseDown) return;
    const dx = e.clientX - mdStartX;
    const chartWidth = canvas.clientWidth;
    const labelDelta = Math.round(-dx / (chartWidth / Math.max(1, windowState[key].size)));
    windowState[key].start = mdStartWindowStart + labelDelta;
    refreshChartSimple(key);
  });
  window.addEventListener('mouseup', e => {
    if (mouseDown) { mouseDown = false; canvas.style.cursor = 'default'; }
  });
}

attachZoomPan(document.getElementById('chartVoltage'), 'voltage');
attachZoomPan(document.getElementById('chartCurrent'), 'current');
attachZoomPan(document.getElementById('chartTemp'), 'temp');
attachZoomPan(document.getElementById('chartLeak'), 'leak');

/* nice initial fill for charts if empty */
function fillEmptyData() {
  const now = Date.now();
  for (let i = 0; i < 20; i++) {
    const ts = now - (19 - i) * 1000;
    for (const k of ['voltage', 'current', 'temp', 'leak']) {
      pushHistory(k, ts, 0);
    }
  }
  for (const k of ['voltage', 'current', 'temp', 'leak']) refreshChartSimple(k);
}
fillEmptyData();

/* Start listener */
function startData() {
  const sensorRef = db.ref('sensor_data');
  sensorRef.once('value', snap => {
    if (snap.exists()) {
      conn.innerHTML = '<i class="fas fa-wifi"></i> Connected (sensor_data)';
      sensorRef.on('value', s => {
        const obj = s.val(); if (!obj) return;
        const keys = Object.keys(obj); if (keys.length === 0) return;
        const latest = obj[keys.sort().pop()];
        applyData(latest);
      }, err => { console.error(err); });
    } else {
      conn.innerHTML = '<i class="fas fa-wifi"></i> Connected (root)';
      db.ref('voltage').on('value', s => { applyData({ voltage: s.val() }); }, e => console.error(e));
      db.ref('current').on('value', s => { applyData({ current: s.val() }); }, e => console.error(e));
      db.ref('temperature').on('value', s => { applyData({ temperature: s.val() }); }, e => console.error(e));
      db.ref('leakage_current').on('value', s => { applyData({ leakage: s.val() }); }, e => console.error(e));
      db.ref('relay').on('value', s => { if (s.exists()) setRelayUI(s.val() === 1); }, e => console.error(e));
    }
  }, e => console.error(e));
}
startData();

/* Also listen to manual_controls/relay_status to reflect external changes */
db.ref('manual_controls/relay_status').on('value', s => { if (s.exists()) setRelayUI(String(s.val()).toUpperCase()==='OPEN'); });

</script>
</body>
</html>