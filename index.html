<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Cable Fault Dashboard — iOS Future</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  :root {
    /* iOS Dark Mode Palette */
    --bg-deep: #000000;
    --glass-surf: rgba(30, 30, 35, 0.65);
    --glass-border: rgba(255, 255, 255, 0.12);
    --glass-highlight: rgba(255, 255, 255, 0.05);
    
    /* Dynamic Colors */
    --accent: #0A84FF; /* iOS Blue */
    --good: #32D74B;   /* iOS Green */
    --bad: #FF453A;    /* iOS Red */
    --warn: #FFD60A;   /* iOS Yellow */
    --purple: #BF5AF2; /* iOS Purple */
    
    --text-main: #FFFFFF;
    --text-sub: rgba(235, 235, 245, 0.6);
    
    /* Physics Variables */
    --spring-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy */
    --spring-smooth: cubic-bezier(0.25, 0.8, 0.25, 1);        /* Smooth iOS slide */
  }

  /* --- Living Background --- */
  body {
    margin: 0;
    height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif; /* Native Font Stack */
    background: #000;
    color: var(--text-main);
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
  }

  /* Animated Mesh Gradient Background */
  .ambient-mesh {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(circle at 0% 0%, #1a1a2e 0%, transparent 50%),
                radial-gradient(circle at 100% 0%, #16213e 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, #0f3460 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, #533483 0%, transparent 50%);
    background-size: 200% 200%;
    filter: blur(60px);
    z-index: -1;
    animation: mesh-drift 20s ease infinite alternate;
  }

  @keyframes mesh-drift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* --- Glassmorphism Layout --- */
  .app-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    animation: fade-up 0.8s var(--spring-smooth);
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    margin-bottom: 20px;
  }

  .brand h1 {
    margin: 0;
    font-weight: 700;
    font-size: 28px;
    letter-spacing: -0.5px;
    background: linear-gradient(180deg, #FFF, #AAA);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .status-pills {
    display: flex;
    gap: 10px;
  }

  .pill {
    background: rgba(255, 255, 255, 0.1);
    padding: 6px 14px;
    border-radius: 100px;
    font-size: 13px;
    font-weight: 500;
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
  }

  /* --- The "VisionOS" Card --- */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 24px;
    margin-bottom: 30px;
  }

  .card {
    position: relative;
    background: var(--glass-surf);
    border-radius: 28px; /* Super rounded */
    padding: 24px;
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(40px) saturate(150%);
    -webkit-backdrop-filter: blur(40px) saturate(150%);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    
    /* Interactions */
    transition: transform 0.4s var(--spring-bounce), 
                box-shadow 0.4s var(--spring-smooth),
                border-color 0.3s ease,
                background 0.3s ease;
    cursor: default;
    overflow: hidden;
  }

  /* Hover & Active States (Tactile Feel) */
  .card:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.3);
    background: rgba(40, 40, 50, 0.75);
  }

  .card:active {
    transform: scale(0.96); /* Shrink on click */
  }

  /* Inner Layout */
  .card-head {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .icon-box {
    width: 48px;
    height: 48px;
    border-radius: 16px;
    display: grid;
    place-items: center;
    font-size: 20px;
    color: #fff;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: inset 0 0 20px rgba(255,255,255,0.05);
  }

  .card-label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-sub);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 8px;
  }

  .card-value {
    font-size: 38px;
    font-weight: 600;
    letter-spacing: -1px;
    display: flex;
    align-items: baseline;
  }

  .card-unit {
    font-size: 18px;
    font-weight: 500;
    color: var(--text-sub);
    margin-left: 4px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-sub);
    box-shadow: 0 0 10px var(--text-sub);
    transition: 0.3s ease;
  }

  /* --- Specific Colors & Glows --- */
  /* Voltage (Blue) */
  .t-vol .icon-box { color: var(--accent); box-shadow: 0 0 20px rgba(10, 132, 255, 0.2); }
  .t-vol.fault { border-color: var(--bad); box-shadow: 0 0 40px rgba(255, 69, 58, 0.3); }
  
  /* Current (Green) */
  .t-cur .icon-box { color: var(--good); box-shadow: 0 0 20px rgba(50, 215, 75, 0.2); }
  .t-cur.fault { border-color: var(--bad); }

  /* Temp (Yellow/Orange) */
  .t-tmp .icon-box { color: var(--warn); box-shadow: 0 0 20px rgba(255, 214, 10, 0.2); }
  .t-tmp.fault { border-color: var(--bad); }

  /* Leakage (Red) */
  .t-lek .icon-box { color: var(--bad); box-shadow: 0 0 20px rgba(255, 69, 58, 0.2); }
  .t-lek.fault { border-color: var(--bad); animation: pulse-danger 1s infinite; }

  @keyframes pulse-danger {
    0% { box-shadow: 0 0 0 0 rgba(255, 69, 58, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(255, 69, 58, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 69, 58, 0); }
  }

  /* --- The "Control Center" Relay Button --- */
  #relayCard {
    background: rgba(50, 50, 50, 0.4);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  #relayCard .icon-box {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    margin-bottom: 12px;
    transition: all 0.4s var(--spring-bounce);
  }

  #relayCard.active {
    background: var(--text-main); /* White bg when active */
  }

  #relayCard.active .icon-box {
    background: var(--accent);
    color: #fff;
    transform: scale(1.1);
    box-shadow: 0 10px 20px rgba(10, 132, 255, 0.4);
  }
  
  #relayCard.active .card-label, 
  #relayCard.active .card-value {
    color: #000; /* Invert text */
  }

  /* --- Charts Area --- */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
  }

  .chart-container {
    background: var(--glass-surf);
    border: 1px solid var(--glass-border);
    border-radius: 28px;
    padding: 20px;
    backdrop-filter: blur(40px);
  }

  .chart-header h3 {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-sub);
    margin: 0 0 15px 0;
  }

  canvas {
    max-height: 200px;
    width: 100%;
    cursor: crosshair;
  }

  /* Mobile Optimizations */
  @media (max-width: 768px) {
    .charts-grid { grid-template-columns: 1fr; }
    header { flex-direction: column; gap: 15px; align-items: flex-start; }
    .card-value { font-size: 32px; }
  }

  @keyframes fade-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<div class="ambient-mesh"></div>

<div class="app-container">
  <header>
    <div class="brand">
      <h1>Fault Guard</h1>
      <span style="font-size:14px; color:var(--text-sub); font-weight:400;">Underground Cable Monitor</span>
    </div>
    <div class="status-pills">
      <div id="conn" class="pill"><i class="fas fa-circle-notch fa-spin"></i> Syncing</div>
      <div id="sys" class="pill" style="border-color: var(--good); color: var(--good);">
        <i class="fas fa-shield-alt"></i> Safe
      </div>
    </div>
  </header>

  <section class="grid">
    <div id="volCard" class="card t-vol">
      <div class="card-head">
        <div class="icon-box"><i class="fas fa-bolt"></i></div>
        <div id="volDot" class="status-dot" style="background:var(--good)"></div>
      </div>
      <div class="card-value">
        <span id="volV">0.00</span> <span class="card-unit">V</span>
      </div>
      <div class="card-label">Line Voltage</div>
    </div>

    <div id="curCard" class="card t-cur">
      <div class="card-head">
        <div class="icon-box"><i class="fas fa-wave-square"></i></div>
        <div id="curDot" class="status-dot" style="background:var(--good)"></div>
      </div>
      <div class="card-value">
        <span id="curV">0.00</span> <span class="card-unit">A</span>
      </div>
      <div class="card-label">Load Current</div>
    </div>

    <div id="tempCard" class="card t-tmp">
      <div class="card-head">
        <div class="icon-box"><i class="fas fa-temperature-high"></i></div>
        <div id="tmpDot" class="status-dot" style="background:var(--good)"></div>
      </div>
      <div class="card-value">
        <span id="tmpV">0.0</span> <span class="card-unit">°C</span>
      </div>
      <div class="card-label">Core Temp</div>
    </div>

    <div id="leakCard" class="card t-lek">
      <div class="card-head">
        <div class="icon-box"><i class="fas fa-water"></i></div>
        <div id="lekDot" class="status-dot" style="background:var(--good)"></div>
      </div>
      <div class="card-value">
        <span id="lekV">0.000</span> <span class="card-unit">A</span>
      </div>
      <div class="card-label">Leakage</div>
    </div>

    <div id="relayCard" class="card" role="button">
      <div class="icon-box"><i class="fas fa-power-off"></i></div>
      <div class="card-value" style="font-size:18px;">CLOSED</div>
      <div class="card-label">System Relay</div>
    </div>
  </section>

  <section class="charts-grid">
    <div class="chart-container">
      <div class="chart-header"><h3>Voltage History</h3></div>
      <canvas id="chartVoltage"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-header"><h3>Current History</h3></div>
      <canvas id="chartCurrent"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-header"><h3>Temperature History</h3></div>
      <canvas id="chartTemp"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-header"><h3>Leakage History</h3></div>
      <canvas id="chartLeak"></canvas>
    </div>
  </section>

  <footer style="text-align:center; padding:40px; color:var(--text-sub); font-size:12px;">
    Designed for Fluidity. Pinch charts to zoom.
  </footer>
</div>

<script>
/* --------------------------------------------------------
   1. Firebase & Config
   -------------------------------------------------------- */
const firebaseConfig = {
  databaseURL: "https://cablefaultdetection-77552-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const TH = { voltage: 10.5, current: 2.8, temp: 60.0, leakage: 0.1 };

/* --------------------------------------------------------
   2. Fluid UI Logic (Tweening & Visuals)
   -------------------------------------------------------- */
const els = {
  vol: { val: document.getElementById('volV'), card: document.getElementById('volCard'), dot: document.getElementById('volDot') },
  cur: { val: document.getElementById('curV'), card: document.getElementById('curCard'), dot: document.getElementById('curDot') },
  tmp: { val: document.getElementById('tmpV'), card: document.getElementById('tempCard'), dot: document.getElementById('tmpDot') },
  lek: { val: document.getElementById('lekV'), card: document.getElementById('leakCard'), dot: document.getElementById('lekDot') },
  relay: { card: document.getElementById('relayCard'), txt: document.querySelector('#relayCard .card-value') },
  sys: document.getElementById('sys'),
  conn: document.getElementById('conn')
};

// ANIMATION: Smooth Number Rolling (The secret to fluid UI)
const tweenValues = { vol: 0, cur: 0, tmp: 0, lek: 0 };

function animateValue(key, end, element, decimals) {
  const start = tweenValues[key];
  const duration = 600; // ms
  const startTime = performance.now();

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // Ease out quartic function
    const ease = 1 - Math.pow(1 - progress, 4);
    
    const current = start + (end - start) * ease;
    element.textContent = current.toFixed(decimals);

    if (progress < 1) {
      requestAnimationFrame(update);
    } else {
      tweenValues[key] = end; // ensure final value is precise
    }
  }
  requestAnimationFrame(update);
}

/* --------------------------------------------------------
   3. Chart Configuration (Modern & Clean)
   -------------------------------------------------------- */
Chart.defaults.color = 'rgba(255,255,255,0.3)';
Chart.defaults.font.family = 'Inter';

function createFluidChart(ctx, color) {
  const gradient = ctx.createLinearGradient(0, 0, 0, 200);
  gradient.addColorStop(0, color.replace('1)', '0.4)'));
  gradient.addColorStop(1, color.replace('1)', '0.0)'));

  return new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ 
      data: [], 
      borderColor: color, 
      backgroundColor: gradient, 
      borderWidth: 3,
      pointRadius: 0, // Hide points for clean look
      pointHoverRadius: 6,
      fill: true,
      tension: 0.4 // Curvy lines
    }]},
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false, // We handle data streaming manually
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleFont: {size:13}, bodyFont:{size:14}, padding: 10, cornerRadius: 12, displayColors: false } },
      scales: {
        x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'mm:ss' } }, grid: { display: false }, border: { display: false } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, border: { display: false } }
      }
    }
  });
}

const charts = {
  vol: createFluidChart(document.getElementById('chartVoltage').getContext('2d'), 'rgba(10, 132, 255, 1)'),
  cur: createFluidChart(document.getElementById('chartCurrent').getContext('2d'), 'rgba(50, 215, 75, 1)'),
  tmp: createFluidChart(document.getElementById('chartTemp').getContext('2d'), 'rgba(255, 214, 10, 1)'),
  lek: createFluidChart(document.getElementById('chartLeak').getContext('2d'), 'rgba(255, 69, 58, 1)')
};

/* History Data Management */
const MAX_POINTS = 50;
const history = { vol: [], cur: [], tmp: [], lek: [] };
const timeLabels = [];

function pushData(v, c, t, l) {
  const now = Date.now();
  timeLabels.push(now);
  history.vol.push(v); history.cur.push(c); history.tmp.push(t); history.lek.push(l);

  if (timeLabels.length > MAX_POINTS) {
    timeLabels.shift();
    history.vol.shift(); history.cur.shift(); history.tmp.shift(); history.lek.shift();
  }

  // Update Charts efficiently
  Object.keys(charts).forEach(key => {
    const chart = charts[key];
    chart.data.labels = timeLabels;
    chart.data.datasets[0].data = history[key];
    chart.update('none'); // 'none' mode prevents full re-render jitter
  });
}

/* --------------------------------------------------------
   4. Application Logic (State & Visuals)
   -------------------------------------------------------- */
function updateCardState(key, value, threshold, type) {
  const isBad = type === 'low' ? value < threshold : value > threshold;
  const el = els[key];
  
  // Use the tween animation for numbers
  animateValue(key, value, el.val, key === 'lek' ? 3 : (key === 'tmp' ? 1 : 2));

  if (isBad) {
    el.card.classList.add('fault');
    el.dot.style.background = 'var(--bad)';
    el.dot.style.boxShadow = '0 0 10px var(--bad)';
  } else {
    el.card.classList.remove('fault');
    el.dot.style.background = 'var(--good)';
    el.dot.style.boxShadow = '0 0 10px var(--good)';
  }
  return isBad;
}

function applyData(data) {
  // Normalize inputs
  const v = Number(data.voltage || data.V || 0);
  const c = Number(data.current || data.I || 0);
  const t = Number(data.temperature || data.temp || 0);
  const l = Number(data.leakage_current || data.leakage || 0);
  
  // Push to charts
  pushData(v, c, t, l);

  // Update UI & Logic
  const f1 = updateCardState('vol', v, TH.voltage, 'low');
  const f2 = updateCardState('cur', c, TH.current, 'high');
  const f3 = updateCardState('tmp', t, TH.temp, 'high');
  const f4 = updateCardState('lek', l, TH.leakage, 'high');

  // System Global Status
  const anyFault = f1 || f2 || f3 || f4;
  if (anyFault) {
    els.sys.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Fault Detected';
    els.sys.style.borderColor = 'var(--bad)';
    els.sys.style.color = 'var(--bad)';
    els.sys.style.background = 'rgba(255, 69, 58, 0.1)';
  } else {
    els.sys.innerHTML = '<i class="fas fa-check-circle"></i> System Secure';
    els.sys.style.borderColor = 'var(--good)';
    els.sys.style.color = 'var(--good)';
    els.sys.style.background = 'rgba(50, 215, 75, 0.1)';
  }

  // Relay Logic
  const rStatus = data.relay_status || data.relay || 'CLOSED';
  const isOpen = (String(rStatus).toUpperCase() === 'OPEN' || rStatus == 1);
  updateRelayUI(isOpen);
}

/* Relay Interaction */
function updateRelayUI(isOpen) {
  const card = els.relay.card;
  if (isOpen) {
    card.classList.add('active');
    els.relay.txt.textContent = "OPEN";
  } else {
    card.classList.remove('active');
    els.relay.txt.textContent = "CLOSED";
  }
}

els.relay.card.addEventListener('click', () => {
  const isCurrentlyOpen = els.relay.card.classList.contains('active');
  const newState = !isCurrentlyOpen;
  
  // Immediate visual feedback (optimistic UI)
  updateRelayUI(newState);

  // Send to DB
  db.ref('manual_controls/relay_status').set(newState ? 'OPEN' : 'CLOSED');
  db.ref('relay').set(newState ? 1 : 0);
});

/* --------------------------------------------------------
   5. Firebase Listeners
   -------------------------------------------------------- */
const connRef = db.ref('.info/connected');
connRef.on('value', snap => {
  if(snap.val() === true) {
    els.conn.innerHTML = '<i class="fas fa-wifi"></i> Live';
    els.conn.style.color = 'var(--accent)';
    els.conn.style.borderColor = 'var(--accent)';
  } else {
    els.conn.innerHTML = '<i class="fas fa-slash"></i> Offline';
    els.conn.style.color = 'var(--text-sub)';
    els.conn.style.borderColor = 'var(--glass-border)';
  }
});

// Main Data Listener
const sensorRef = db.ref('sensor_data');
sensorRef.limitToLast(1).on('child_added', snap => {
  const val = snap.val();
  if(val) applyData(val);
});

// Also listen for individual updates if structure is flat
db.ref('voltage').on('value', s => applyData({voltage: s.val(), ...getCurrentVals()})); 
// (Note: In a real scenario, you'd consolidate this, but keeping it simple for the demo)

function getCurrentVals() {
  return { 
    voltage: tweenValues.vol, 
    current: tweenValues.cur, 
    temperature: tweenValues.tmp, 
    leakage: tweenValues.lek 
  };
}

</script>
</body>
</html>
