<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>Fault Guard iOS 26</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  :root {
    --bg-deep: #000000;
    --glass: rgba(30, 30, 35, 0.70);
    --glass-border: rgba(255, 255, 255, 0.12);
    --accent: #0A84FF;
    --good: #30D158;
    --bad: #FF453A;
    --warn: #FFD60A;
    --text-main: #FFFFFF;
    --text-sub: rgba(235, 235, 245, 0.6);
    --spring: cubic-bezier(0.175, 0.885, 0.32, 1.1);
    --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 20px);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
  
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: 'Inter', sans-serif;
    overflow: hidden; /* Prevent scroll, we use internal scroll */
    height: 100vh;
  }

  /* Background Mesh */
  .mesh {
    position: fixed; inset: 0; z-index: -1;
    background: radial-gradient(circle at 0% 0%, #1a1a2e 0, transparent 50%), 
                radial-gradient(circle at 100% 100%, #2d1b4e 0, transparent 60%);
    filter: blur(80px); opacity: 0.5;
  }

  /* --- Layout --- */
  .app {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: calc(var(--safe-top) + 10px) 20px calc(var(--safe-bottom) + 20px) 20px;
    overflow-y: auto;
  }

  header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 25px;
  }
  .brand h1 { font-size: 22px; margin: 0; letter-spacing: -0.5px; }
  .status-pill {
    background: rgba(255,255,255,0.1); padding: 6px 12px; 
    border-radius: 20px; font-size: 12px; font-weight: 600;
    display: flex; gap: 6px; align-items: center;
    backdrop-filter: blur(10px);
  }

  /* --- Cards --- */
  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 30px;
  }

  .card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 16px;
    position: relative;
    transition: transform 0.2s var(--spring);
    cursor: pointer;
  }
  .card:active { transform: scale(0.95); }

  .icon-box {
    width: 38px; height: 38px; border-radius: 10px;
    background: rgba(255,255,255,0.08); display: grid; place-items: center;
    font-size: 16px; margin-bottom: 10px;
    color: var(--text-sub);
  }
  
  .card-label { font-size: 12px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
  .card-val { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -1px; }
  .unit { font-size: 14px; color: var(--text-sub); margin-left: 2px; font-weight: 500; }

  /* Dynamic Card Colors */
  .c-vol.active .icon-box { color: var(--accent); background: rgba(10,132,255,0.15); }
  .c-cur.active .icon-box { color: var(--good); background: rgba(48,209,88,0.15); }
  .c-tmp.active .icon-box { color: var(--warn); background: rgba(255,214,10,0.15); }
  .c-lek.active .icon-box { color: var(--bad); background: rgba(255,69,58,0.15); }
  
  .card.fault { border-color: var(--bad); box-shadow: 0 0 20px rgba(255, 69, 58, 0.2); }

  .tap-hint {
    position: absolute; top: 16px; right: 16px;
    font-size: 10px; color: var(--text-sub); opacity: 0.5;
  }

  /* --- EMERGENCY BUTTON --- */
  .hazard-container {
    margin-top: auto; /* Push to bottom */
    display: flex; justify-content: center;
    padding: 10px 0;
  }

  .emer-btn {
    position: relative;
    width: 100%; max-width: 320px;
    height: 80px;
    border-radius: 20px;
    background: #1c1c1e;
    border: none;
    display: flex; align-items: center; justify-content: center;
    gap: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    overflow: hidden;
    transition: all 0.3s var(--spring);
    cursor: pointer;
  }

  /* Striped Border Effect */
  .emer-btn::before {
    content: ''; position: absolute; inset: 0;
    border-radius: 20px;
    padding: 3px; /* Border width */
    background: repeating-linear-gradient(45deg, #333, #333 10px, #444 10px, #444 20px);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0.5;
  }

  .emer-icon {
    width: 40px; height: 40px; border-radius: 50%;
    background: #2c2c2e; color: #fff;
    display: grid; place-items: center; font-size: 18px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: all 0.3s;
  }
  
  .emer-text { text-align: left; }
  .emer-lbl { font-size: 11px; color: #888; letter-spacing: 1px; text-transform: uppercase; }
  .emer-status { font-size: 18px; font-weight: 800; color: #fff; letter-spacing: -0.5px; }

  /* Button Pressed State */
  .emer-btn:active { transform: scale(0.94); }

  /* STATE: EMERGENCY (OPEN) */
  .emer-btn.tripped {
    background: linear-gradient(135deg, #500000, #8b0000);
    box-shadow: 0 0 30px rgba(255, 69, 58, 0.4);
    animation: shake 0.5s ease-in-out;
  }
  .emer-btn.tripped::before {
    background: repeating-linear-gradient(45deg, #ffcc00, #ffcc00 10px, #000 10px, #000 20px);
    opacity: 1;
  }
  .emer-btn.tripped .emer-icon { background: #fff; color: #b00; animation: pulse-fast 1s infinite; }
  .emer-btn.tripped .emer-status { color: #ffaaaa; }

  /* STATE: ARMED (CLOSED) */
  .emer-btn.armed .emer-icon { color: var(--good); text-shadow: 0 0 10px var(--good); }

  /* --- CHART MODAL (Hidden by default) --- */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 999;
    background: rgba(0,0,0,0.01); /* Transparent click blocker */
    display: none;
    align-items: flex-end; /* Bottom sheet */
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal-card {
    width: 100%; height: 65vh;
    background: rgba(20, 20, 25, 0.9);
    backdrop-filter: blur(25px) saturate(180%);
    border-top-left-radius: 32px; border-top-right-radius: 32px;
    border-top: 1px solid var(--glass-border);
    box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
    padding: 24px;
    display: flex; flex-direction: column;
    transform: translateY(100%);
    transition: transform 0.4s var(--spring);
  }
  .modal-overlay.open .modal-card { transform: translateY(0); }

  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .modal-title { font-size: 20px; font-weight: 700; }
  .close-btn { 
    background: rgba(255,255,255,0.1); border: none; color: #fff; 
    width: 32px; height: 32px; border-radius: 50%; cursor: pointer; 
    display:grid; place-items: center;
  }

  canvas { width: 100% !important; height: 100% !important; }

  /* Animations */
  @keyframes pulse-fast { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }

</style>
</head>
<body>

<div class="mesh"></div>

<div class="app">
  <header>
    <div class="brand">
      <h1>Fault Guard</h1>
    </div>
    <div id="sys" class="status-pill" style="color:var(--good)">
      <i class="fas fa-shield-alt"></i> System Normal
    </div>
  </header>

  <div class="grid">
    <div id="cVol" class="card c-vol active" onclick="openChart('vol')">
      <div class="tap-hint"><i class="fas fa-chart-line"></i></div>
      <div class="icon-box"><i class="fas fa-bolt"></i></div>
      <div class="card-label">Line Voltage</div>
      <div class="card-val"><span id="vVol">0.0</span><span class="unit">V</span></div>
    </div>

    <div id="cCur" class="card c-cur active" onclick="openChart('cur')">
      <div class="tap-hint"><i class="fas fa-chart-line"></i></div>
      <div class="icon-box"><i class="fas fa-wave-square"></i></div>
      <div class="card-label">Current</div>
      <div class="card-val"><span id="vCur">0.00</span><span class="unit">A</span></div>
    </div>

    <div id="cTmp" class="card c-tmp active" onclick="openChart('tmp')">
      <div class="tap-hint"><i class="fas fa-chart-line"></i></div>
      <div class="icon-box"><i class="fas fa-temperature-high"></i></div>
      <div class="card-label">Core Temp</div>
      <div class="card-val"><span id="vTmp">0.0</span><span class="unit">Â°C</span></div>
    </div>

    <div id="cLek" class="card c-lek active" onclick="openChart('lek')">
      <div class="tap-hint"><i class="fas fa-chart-line"></i></div>
      <div class="icon-box"><i class="fas fa-droplet"></i></div>
      <div class="card-label">Leakage</div>
      <div class="card-val"><span id="vLek">0.00</span><span class="unit">A</span></div>
    </div>
  </div>

  <div class="hazard-container">
    <button id="btnEmer" class="emer-btn armed">
      <div class="emer-icon"><i class="fas fa-power-off"></i></div>
      <div class="emer-text">
        <div class="emer-lbl">System Relay</div>
        <div class="emer-status" id="txtRelay">ARMED</div>
      </div>
    </button>
  </div>
</div>

<div id="chartModal" class="modal-overlay" onclick="closeChart(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Voltage History</div>
      <button class="close-btn" onclick="closeChart()"><i class="fas fa-times"></i></button>
    </div>
    <div style="flex:1; position: relative; width:100%;">
      <canvas id="chartMain"></canvas>
    </div>
  </div>
</div>

<script>
/* --- Init Firebase --- */
const firebaseConfig = { databaseURL: "https://cablefaultdetection-77552-default-rtdb.firebaseio.com/" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const TH = { vol: 10.5, cur: 2.8, tmp: 60.0, lek: 0.1 };

/* --- UI Elements --- */
const ui = {
  v: { el: document.getElementById('vVol'), card: document.getElementById('cVol') },
  c: { el: document.getElementById('vCur'), card: document.getElementById('cCur') },
  t: { el: document.getElementById('vTmp'), card: document.getElementById('cTmp') },
  l: { el: document.getElementById('vLek'), card: document.getElementById('cLek') },
  sys: document.getElementById('sys'),
  relay: { btn: document.getElementById('btnEmer'), txt: document.getElementById('txtRelay') }
};

/* --- Charting (Single Canvas Reused) --- */
let mainChartInstance = null;
const ctx = document.getElementById('chartMain').getContext('2d');

// Data Stores
const history = { vol: [], cur: [], tmp: [], lek: [] };
const labels = { vol: [], cur: [], tmp: [], lek: [] };
const MAX_PTS = 50;

function updateHist(key, val) {
  const now = new Date();
  history[key].push(val);
  labels[key].push(now);
  if(history[key].length > MAX_PTS) { history[key].shift(); labels[key].shift(); }
}

/* --- Modal Logic --- */
let currentChartType = null;
const modal = document.getElementById('chartModal');
const modalTitle = document.getElementById('modalTitle');

function openChart(type) {
  currentChartType = type;
  
  // Set Titles & Colors
  let color = '#fff';
  if(type === 'vol') { modalTitle.textContent = 'Line Voltage'; color = '#0A84FF'; }
  if(type === 'cur') { modalTitle.textContent = 'Load Current'; color = '#30D158'; }
  if(type === 'tmp') { modalTitle.textContent = 'Core Temp'; color = '#FFD60A'; }
  if(type === 'lek') { modalTitle.textContent = 'Leakage Current'; color = '#FF453A'; }

  // Build/Update Chart
  if(mainChartInstance) mainChartInstance.destroy();
  
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, color);
  gradient.addColorStop(1, 'rgba(0,0,0,0)');

  mainChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels[type],
      datasets: [{
        data: history[type],
        borderColor: color,
        backgroundColor: gradient,
        fill: true,
        pointRadius: 2,
        borderWidth: 3,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'mm:ss' } }, grid: { display: false }, ticks: { color: '#666' } },
        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#666' } }
      }
    }
  });

  // Show Modal
  modal.classList.add('open');
}

function closeChart(e) {
  modal.classList.remove('open');
  currentChartType = null;
}

/* --- Data Processing --- */
function processData(data) {
  const v = Number(data.voltage || 0);
  const c = Number(data.current || 0);
  const t = Number(data.temperature || 0);
  const l = Number(data.leakage_current || 0);

  // Update UI Numbers
  ui.v.el.textContent = v.toFixed(1);
  ui.c.el.textContent = c.toFixed(2);
  ui.t.el.textContent = t.toFixed(1);
  ui.l.el.textContent = l.toFixed(3);

  // Check Faults
  checkFault(ui.v.card, v < TH.vol);
  checkFault(ui.c.card, c > TH.cur);
  checkFault(ui.t.card, t > TH.tmp);
  checkFault(ui.l.card, l > TH.lek);

  // System Status
  const anyFault = (v < TH.vol) || (c > TH.cur) || (t > TH.tmp) || (l > TH.lek);
  if(anyFault) {
    ui.sys.innerHTML = '<i class="fas fa-exclamation-triangle"></i> FAULT';
    ui.sys.style.color = 'var(--bad)';
  } else {
    ui.sys.innerHTML = '<i class="fas fa-shield-alt"></i> SECURE';
    ui.sys.style.color = 'var(--good)';
  }

  // Update History arrays
  updateHist('vol', v); updateHist('cur', c); updateHist('tmp', t); updateHist('lek', l);

  // If chart is open, update it live
  if(currentChartInstance && currentChartType) {
    currentChartInstance.data.labels = labels[currentChartType];
    currentChartInstance.data.datasets[0].data = history[currentChartType];
    currentChartInstance.update('none');
  }

  // Relay
  const rStat = data.relay_status || 'CLOSED';
  const isOpen = (String(rStat).toUpperCase() === 'OPEN' || rStat == 1);
  setRelayVisuals(isOpen);
}

function checkFault(card, isFault) {
  if(isFault) card.classList.add('fault');
  else card.classList.remove('fault');
}

/* --- Emergency Button Logic --- */
function setRelayVisuals(isOpen) {
  const btn = ui.relay.btn;
  const txt = ui.relay.txt;
  
  if(isOpen) {
    // EMERGENCY STATE
    btn.className = 'emer-btn tripped';
    txt.textContent = 'TRIPPED';
    // Vibration on mobile
    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
  } else {
    // ARMED STATE
    btn.className = 'emer-btn armed';
    txt.textContent = 'ARMED';
  }
}

ui.relay.btn.addEventListener('click', () => {
  const isTripped = ui.relay.btn.classList.contains('tripped');
  const nextState = !isTripped; // Toggle
  
  // Optimistic UI update
  setRelayVisuals(nextState);
  
  // Send to Firebase
  db.ref('manual_controls/relay_status').set(nextState ? 'OPEN' : 'CLOSED');
  db.ref('relay').set(nextState ? 1 : 0);
});

/* --- Firebase Listener --- */
db.ref('sensor_data').limitToLast(1).on('child_added', s => { if(s.val()) processData(s.val()); });
// Fallback for flat data
db.ref('voltage').on('value', s => {
    // In a real app, fetch all, here we just trigger update
    processData({
        voltage: s.val(), 
        current: ui.c.el.textContent,
        temperature: ui.t.el.textContent,
        leakage_current: ui.l.el.textContent,
        relay_status: ui.relay.txt.textContent === 'TRIPPED' ? 'OPEN' : 'CLOSED'
    });
});

</script>
</body>
</html>
