<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111318">
<title>Fault Guard App</title>

<!-- Fonts: Roboto for Material Design -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<!-- Material Symbols (Optional, using FA for compatibility but styled like Material) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root {
    /* MD3 Dark Theme Palette */
    --md-sys-color-background: #111318;
    --md-sys-color-on-background: #e2e2e6;
    --md-sys-color-surface: #111318;
    --md-sys-color-surface-container: #1d2024;
    --md-sys-color-surface-container-high: #282a2f;
    --md-sys-color-primary: #a8c7fa;
    --md-sys-color-on-primary: #003062;
    --md-sys-color-primary-container: #00478a;
    --md-sys-color-secondary: #c2c7cf;
    --md-sys-color-tertiary: #d7bce1;
    --md-sys-color-error: #ffb4ab;
    --md-sys-color-outline: #8e9199;
    
    /* Functional Colors */
    --color-good: #bcebe2; /* Mint */
    --color-on-good: #003730;
    --color-warn: #ffdf9e;
    --color-bad: #ffb4ab;

    /* Metrics */
    --radius-l: 28px;
    --radius-m: 16px;
    --radius-s: 12px;
    --space-page: 16px;
    
    /* Animation */
    --ease-spring: cubic-bezier(0.2, 0.0, 0, 1.0);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
  
  body {
    margin: 0;
    background-color: var(--md-sys-color-background);
    color: var(--md-sys-color-on-background);
    font-family: 'Roboto', sans-serif;
    overflow: hidden; /* App-like: no window scroll */
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Animated Gradient Background */
  .mesh {
    position: fixed; inset: 0; z-index: -1;
    /* Deep Moving Gradient */
    background: linear-gradient(300deg, #0f0c29, #302b63, #24243e, #02182b, #004d40);
    background-size: 400% 400%;
    animation: gradientMove 18s ease infinite;
  }
  .mesh::after {
    content: ''; position: absolute; inset: 0;
    background: rgba(0, 0, 0, 0.4); /* Light overlay to ensure text contrast */
  }

  @keyframes gradientMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* --- APP BAR (Top) --- */
  .top-app-bar {
    padding: 16px 20px;
    display: flex; justify-content: space-between; align-items: center;
    z-index: 10;
    background: rgba(17, 19, 24, 0.3);
    backdrop-filter: blur(10px);
  }
  
  .headline {
    font-size: 22px;
    font-weight: 400; /* Material You prefers lighter weights for headlines */
    margin: 0;
    color: var(--md-sys-color-on-background);
  }

  .status-chip {
    background: var(--md-sys-color-surface-container-high);
    color: var(--color-good);
    padding: 6px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    display: flex; align-items: center; gap: 8px;
    border: 1px solid rgba(255,255,255,0.1);
  }

  /* --- MAIN CONTENT (Scrollable) --- */
  .content-area {
    flex: 1;
    overflow-y: auto;
    padding: 0 var(--space-page) 100px var(--space-page); /* Bottom padding for FAB/Nav */
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Hides scrollbar for cleaner look */
  .content-area::-webkit-scrollbar { display: none; }

  /* --- MD3 CARDS --- */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .card-md3 {
    background: var(--md-sys-color-surface-container);
    border-radius: var(--radius-l);
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: transform 0.1s linear, background 0.2s;
    /* Slight opacity to show gradient behind */
    background: rgba(29, 32, 36, 0.85); 
    backdrop-filter: blur(12px);
  }
  .card-md3:active {
    transform: scale(0.98);
    background: var(--md-sys-color-surface-container-high);
  }

  /* Card Content */
  .card-icon-area {
    width: 40px; height: 40px;
    border-radius: 12px;
    background: var(--md-sys-color-surface-container-high);
    color: var(--md-sys-color-primary);
    display: grid; place-items: center;
    font-size: 18px;
    margin-bottom: 12px;
  }
  
  .card-label {
    font-size: 14px;
    color: var(--md-sys-color-secondary);
    font-weight: 500;
  }
  
  .card-value {
    font-size: 32px;
    font-weight: 400;
    margin-top: 4px;
    color: var(--md-sys-color-on-background);
  }
  
  .card-unit {
    font-size: 14px;
    color: var(--md-sys-color-secondary);
    margin-left: 2px;
  }

  /* Dynamic States */
  .card-md3.state-bad { background: rgba(62, 24, 24, 0.9); }
  .card-md3.state-bad .card-icon-area { background: #601410; color: #ffb4ab; }
  .card-md3.state-bad .card-value { color: #ffb4ab; }

  /* --- BIG SWITCH (Relay) --- */
  .relay-container {
    background: rgba(40, 42, 47, 0.8);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-l);
    padding: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    border: 1px solid rgba(255,255,255,0.05);
  }
  
  .relay-text h3 { margin: 0; font-size: 18px; font-weight: 500; }
  .relay-text p { margin: 4px 0 0 0; font-size: 12px; color: var(--md-sys-color-secondary); }

  .big-switch {
    width: 64px; height: 36px;
    background: #3f4852;
    border-radius: 100px;
    position: relative;
    transition: background 0.3s var(--ease-spring);
  }
  .switch-handle {
    width: 28px; height: 28px;
    background: #b0b5c0;
    border-radius: 50%;
    position: absolute;
    top: 4px; left: 4px;
    transition: transform 0.3s var(--ease-spring), background 0.3s, width 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  
  /* Tripped State (Red) */
  .big-switch.tripped { background: #93000a; }
  .big-switch.tripped .switch-handle { 
    transform: translateX(28px); 
    background: #ffb4ab; 
    width: 32px; height: 32px; top: 2px; /* Emphasize active state */
  }
  .big-switch.tripped .switch-icon { opacity: 1; }

  /* --- BOTTOM NAVIGATION --- */
  .bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    height: 80px;
    background: rgba(29, 32, 36, 0.95);
    backdrop-filter: blur(20px);
    display: flex;
    justify-content: space-around; /* Space for FAB */
    align-items: center;
    padding: 0 16px;
    border-top-left-radius: 24px;
    border-top-right-radius: 24px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
    z-index: 50;
  }

  .nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    color: var(--md-sys-color-secondary);
    background: none; border: none;
    font-size: 12px; font-weight: 500;
    padding: 8px 16px;
    border-radius: 16px;
    transition: all 0.2s;
  }
  .nav-item i { font-size: 20px; margin-bottom: 2px; }
  
  .nav-item:active {
    background: rgba(255,255,255,0.1);
    color: var(--md-sys-color-on-background);
  }

  /* --- FAB (Floating Action Button) --- */
  .fab {
    position: absolute;
    top: -28px; /* Floating above nav bar */
    right: 24px;
    width: 56px; height: 56px;
    background: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-primary);
    border-radius: 16px; /* Squircle */
    display: grid; place-items: center;
    font-size: 24px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    border: none;
    transition: transform 0.2s;
  }
  .fab:active { transform: scale(0.95); background: var(--md-sys-color-primary); color: #000; }

  /* --- CHART SECTION --- */
  .chart-container {
    background: var(--md-sys-color-surface-container);
    border-radius: var(--radius-l);
    padding: 16px;
    height: 250px;
  }

  /* --- MODAL (Material Dialog) --- */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: none; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s;
  }
  .modal-overlay.open { display: flex; opacity: 1; }

  .md-dialog {
    background: #2b2d31;
    width: 90%; max-width: 400px;
    border-radius: 28px;
    padding: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    transform: scale(0.9); transition: transform 0.3s var(--ease-spring);
    display: flex; flex-direction: column;
    max-height: 80vh;
  }
  .modal-overlay.open .md-dialog { transform: scale(1); }

  .dialog-title { font-size: 24px; margin-bottom: 16px; color: var(--md-sys-color-on-background); }
  
  .md-input {
    width: 100%;
    background: #111318;
    border: 1px solid var(--md-sys-color-outline);
    padding: 16px;
    border-radius: 4px;
    border-top-left-radius: 4px; border-top-right-radius: 4px;
    color: white;
    font-size: 16px;
    margin-bottom: 24px;
  }
  
  .dialog-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: auto; }
  .btn-text {
    background: transparent; color: var(--md-sys-color-primary);
    border: none; padding: 10px 12px; font-weight: 500; font-size: 14px;
    border-radius: 20px;
  }
  .btn-filled {
    background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);
    border: none; padding: 10px 24px; font-weight: 500; font-size: 14px;
    border-radius: 20px;
  }

  /* AI Content */
  .ai-response-area { color: #e2e2e6; line-height: 1.6; overflow-y: auto; }
  .ai-response-area h3 { color: var(--md-sys-color-primary); margin-top:0; }
  
  /* Loading */
  .spinner {
    width: 48px; height: 48px; border: 5px solid rgba(255,255,255,0.1);
    border-left-color: var(--md-sys-color-primary); border-radius: 50%;
    animation: spin 1s linear infinite; margin: 20px auto;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* Hidden Input */
  #cameraInput { display: none; }
</style>
</head>
<body>

<div class="mesh"></div>
<input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleImageUpload(event)">

<!-- TOP BAR -->
<div class="top-app-bar">
  <h1 class="headline">Fault Guard</h1>
  <div id="sys" class="status-chip">
    <i class="fas fa-circle-check"></i> System Normal
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="content-area">
  
  <!-- SENSOR GRID -->
  <div class="grid">
    <div id="cVol" class="card-md3" onclick="openChart('vol')">
      <div class="card-icon-area"><i class="fas fa-bolt"></i></div>
      <div class="card-label">Voltage</div>
      <div class="card-value"><span id="vVol">0.0</span><span class="card-unit">V</span></div>
    </div>

    <div id="cCur" class="card-md3" onclick="openChart('cur')">
      <div class="card-icon-area"><i class="fas fa-wave-square"></i></div>
      <div class="card-label">Current</div>
      <div class="card-value"><span id="vCur">0.00</span><span class="card-unit">A</span></div>
    </div>

    <div id="cTmp" class="card-md3" onclick="openChart('tmp')">
      <div class="card-icon-area"><i class="fas fa-temperature-full"></i></div>
      <div class="card-label">Temp</div>
      <div class="card-value"><span id="vTmp">0.0</span><span class="card-unit">Â°C</span></div>
    </div>

    <div id="cLek" class="card-md3" onclick="openChart('lek')">
      <div class="card-icon-area"><i class="fas fa-droplet"></i></div>
      <div class="card-label">Leakage</div>
      <div class="card-value"><span id="vLek">0.00</span><span class="card-unit">A</span></div>
    </div>
  </div>

  <!-- RELAY SWITCH CARD -->
  <div class="relay-container">
    <div class="relay-text">
      <h3>Master Relay</h3>
      <p id="txtRelay">Status: Armed</p>
    </div>
    <div id="btnRelay" class="big-switch">
      <div class="switch-handle"></div>
    </div>
  </div>

  <!-- CHART CARD (Single View) -->
  <div class="chart-container" style="display:none;" id="mainChartCard">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <span style="font-weight:500; color:var(--md-sys-color-secondary)" id="chartTitle">History</span>
      <i class="fas fa-times" onclick="hideChart()" style="padding:5px;"></i>
    </div>
    <div style="width:100%; height:85%;">
      <canvas id="chartMain"></canvas>
    </div>
  </div>

</div>

<!-- BOTTOM NAVIGATION BAR -->
<div class="bottom-nav">
  <button class="nav-item" onclick="diagnoseSystem()">
    <i class="fas fa-wand-magic-sparkles"></i>
    Diagnose
  </button>
  
  <button class="nav-item" onclick="generateReport()">
    <i class="fas fa-file-lines"></i>
    Report
  </button>
  
  <button class="nav-item" onclick="openSettings()">
    <i class="fas fa-gear"></i>
    Settings
  </button>

  <!-- FAB: Inspect -->
  <button class="fab" onclick="document.getElementById('cameraInput').click()">
    <i class="fas fa-camera"></i>
  </button>
</div>

<!-- MODALS (Dialogs) -->

<!-- SETTINGS -->
<div id="settingsModal" class="modal-overlay" onclick="closeModals(event)">
  <div class="md-dialog" onclick="event.stopPropagation()">
    <div class="dialog-title">Settings</div>
    <p style="color:#aaa; font-size:14px; margin-bottom:10px;">Gemini API Key override:</p>
    <input type="password" id="apiKeyInput" class="md-input" placeholder="Enter key...">
    <div class="dialog-actions">
      <button class="btn-text" onclick="clearSettings()">Reset</button>
      <button class="btn-filled" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<!-- AI RESULTS -->
<div id="aiModal" class="modal-overlay" onclick="closeModals(event)">
  <div class="md-dialog" onclick="event.stopPropagation()">
    <div class="dialog-title" id="aiTitle">Analysis</div>
    <div id="aiLoading" style="text-align:center;">
      <div class="spinner"></div>
      <p style="color:#ccc" id="aiLoadingText">Thinking...</p>
    </div>
    <div id="aiContent" class="ai-response-area" style="display:none;"></div>
    <div class="dialog-actions">
      <button class="btn-text" onclick="closeModals()">Close</button>
    </div>
  </div>
</div>

<script>
/* --- Init Firebase --- */
const firebaseConfig = { 
  databaseURL: "https://cablefaultdetection-77552-default-rtdb.firebaseio.com/" 
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const TH = { vol: 10.5, cur: 2.8, tmp: 60.0, lek: 0.1 };

/* --- UI References --- */
const ui = {
  v: { el: document.getElementById('vVol'), card: document.getElementById('cVol') },
  c: { el: document.getElementById('vCur'), card: document.getElementById('cCur') },
  t: { el: document.getElementById('vTmp'), card: document.getElementById('cTmp') },
  l: { el: document.getElementById('vLek'), card: document.getElementById('cLek') },
  sys: document.getElementById('sys'),
  relay: { btn: document.getElementById('btnRelay'), txt: document.getElementById('txtRelay') }
};

/* --- Charting Setup --- */
let mainChartInstance = null;
const ctx = document.getElementById('chartMain').getContext('2d');
const history = { vol: [], cur: [], tmp: [], lek: [] };
const labels = { vol: [], cur: [], tmp: [], lek: [] };
const MAX_PTS = 50;

function updateHist(key, val) {
  const now = new Date();
  history[key].push(val);
  labels[key].push(now);
  if(history[key].length > MAX_PTS) { history[key].shift(); labels[key].shift(); }
}

function hideChart() {
  document.getElementById('mainChartCard').style.display = 'none';
}

function openChart(type) {
  const card = document.getElementById('mainChartCard');
  const title = document.getElementById('chartTitle');
  card.style.display = 'block';
  
  let color = '#a8c7fa'; // Primary
  if(type === 'vol') { title.innerText = 'Voltage Trend'; color = '#a8c7fa'; }
  if(type === 'cur') { title.innerText = 'Current Trend'; color = '#bcebe2'; }
  if(type === 'tmp') { title.innerText = 'Temp Trend'; color = '#ffdf9e'; }
  if(type === 'lek') { title.innerText = 'Leakage Trend'; color = '#ffb4ab'; }

  if(mainChartInstance) mainChartInstance.destroy();

  const gradient = ctx.createLinearGradient(0, 0, 0, 200);
  gradient.addColorStop(0, color);
  gradient.addColorStop(1, 'rgba(0,0,0,0)');

  mainChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels[type],
      datasets: [{
        data: history[type],
        borderColor: color,
        backgroundColor: gradient,
        fill: true,
        pointRadius: 2,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } }
      }
    }
  });
}

/* --- API Key Management --- */
const HARDCODED_KEY = "AIzaSyDmmEqPcvJIGQrRYOIV_X8rY8NHRGbUVNY"; 

function getApiKey() {
  let key = localStorage.getItem('gemini_api_key');
  if (!key || key.trim() === "") key = HARDCODED_KEY;
  return key;
}

function openSettings() {
  document.getElementById('settingsModal').classList.add('open');
  document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key') || '';
}

function saveSettings() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if(key) localStorage.setItem('gemini_api_key', key);
  closeModals();
}

function clearSettings() {
  localStorage.removeItem('gemini_api_key');
  closeModals();
}

/* --- AI Functions --- */
function closeModals(e) {
  if (e && e.target !== e.currentTarget) return; // Only close if clicking overlay, not content
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
  document.getElementById('cameraInput').value = '';
}

async function callGemini(payload, loadingMsg, title) {
  const apiKey = getApiKey();
  const modal = document.getElementById('aiModal');
  const loader = document.getElementById('aiLoading');
  const content = document.getElementById('aiContent');
  
  document.getElementById('aiTitle').innerText = title;
  document.getElementById('aiLoadingText').innerText = loadingMsg;
  
  modal.classList.add('open');
  loader.style.display = 'block';
  content.style.display = 'none';
  content.innerHTML = '';

  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
    content.innerHTML = marked.parse(text);
    loader.style.display = 'none';
    content.style.display = 'block';
  } catch (err) {
    loader.style.display = 'none';
    content.style.display = 'block';
    content.innerHTML = `<p style="color:var(--md-sys-color-error)">Error: ${err.message}</p>`;
  }
}

function diagnoseSystem() {
  const prompt = `Analyze this telemetry: V=${ui.v.el.innerText}, I=${ui.c.el.innerText}, T=${ui.t.el.innerText}, Leak=${ui.l.el.innerText}. Thresholds: V<10.5, I>2.8, T>60, L>0.1. Identify faults and suggest fixes.`;
  callGemini({ contents: [{ parts: [{ text: prompt }] }] }, "Analyzing...", "Diagnosis");
}

function generateReport() {
  // Simple report logic
  const prompt = `Generate a maintenance report. Current readings: Voltage ${ui.v.el.innerText}V, Current ${ui.c.el.innerText}A. Recent history suggests normal operation or faults? Assess stability.`;
  callGemini({ contents: [{ parts: [{ text: prompt }] }] }, "Generating Report...", "Session Report");
}

function handleImageUpload(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    const b64 = evt.target.result.split(',')[1];
    callGemini({
      contents: [{
        parts: [
          { text: "Inspect this electrical component for damage (burns, fraying, corrosion)." },
          { inline_data: { mime_type: file.type, data: b64 } }
        ]
      }]
    }, "Scanning Image...", "Visual Inspection");
  };
  reader.readAsDataURL(file);
}

/* --- Main Data Logic --- */
let manualLockActive = false;
let manualLockTimer = null;

function processData(data) {
  const v = Number(data.voltage ?? data.Voltage ?? 0);
  const c = Number(data.current ?? data.Current ?? 0);
  const t = Number(data.temperature ?? data.Temperature ?? 0);
  const l = Number(data.leakage_current ?? data.leakage ?? 0);

  ui.v.el.innerText = v.toFixed(1);
  ui.c.el.innerText = c.toFixed(2);
  ui.t.el.innerText = t.toFixed(1);
  ui.l.el.innerText = l.toFixed(3);

  // Fault Visuals
  setCardState(ui.v.card, v < TH.vol);
  setCardState(ui.c.card, c > TH.cur);
  setCardState(ui.t.card, t > TH.tmp);
  setCardState(ui.l.card, l > TH.lek);

  const anyFault = (v < TH.vol) || (c > TH.cur) || (t > TH.tmp) || (l > TH.lek);
  if(anyFault) {
    ui.sys.innerHTML = '<i class="fas fa-triangle-exclamation"></i> Fault Detected';
    ui.sys.style.color = 'var(--md-sys-color-error)';
    ui.sys.style.background = '#601410';
  } else {
    ui.sys.innerHTML = '<i class="fas fa-circle-check"></i> System Normal';
    ui.sys.style.color = 'var(--color-good)';
    ui.sys.style.background = 'var(--md-sys-color-surface-container-high)';
  }

  updateHist('vol', v); updateHist('cur', c); updateHist('tmp', t); updateHist('lek', l);
  if(mainChartInstance) mainChartInstance.update('none');

  if(!manualLockActive) {
    const rStat = data.relay_status ?? 'CLOSED';
    const isOpen = (String(rStat).toUpperCase() === 'OPEN' || rStat == 1);
    setRelayVisuals(isOpen);
  }
}

function setCardState(card, isBad) {
  if(isBad) card.classList.add('state-bad');
  else card.classList.remove('state-bad');
}

function setRelayVisuals(isOpen) {
  const btn = ui.relay.btn;
  const txt = ui.relay.txt;
  if(isOpen) {
    btn.classList.add('tripped'); // Red
    txt.innerText = "Status: TRIPPED (Open)";
    txt.style.color = "var(--md-sys-color-error)";
  } else {
    btn.classList.remove('tripped'); // Grey
    txt.innerText = "Status: ARMED (Closed)";
    txt.style.color = "var(--md-sys-color-secondary)";
  }
}

// Relay Click
ui.relay.btn.addEventListener('click', () => {
  const isTripped = ui.relay.btn.classList.contains('tripped');
  const nextState = !isTripped; // Toggle
  
  setRelayVisuals(nextState);
  manualLockActive = true;
  if(manualLockTimer) clearTimeout(manualLockTimer);
  manualLockTimer = setTimeout(() => { manualLockActive = false; }, 6000);

  db.ref().update({
    'manual_controls/relay_status': nextState ? 'OPEN' : 'CLOSED',
    'relay': nextState ? 1 : 0
  }).catch(e => {
    alert("Error: " + e.message);
    setRelayVisuals(isTripped);
  });
});

// Listeners
const sensorRef = db.ref('sensor_data');
sensorRef.limitToLast(1).on('child_added', s => { if(s.val()) processData(s.val()); });
db.ref('manual_controls/relay_status').on('value', s => {
  if(!manualLockActive && s.exists()) {
    setRelayVisuals(String(s.val()).toUpperCase() === 'OPEN');
  }
});

</script>
</body>
</html>
