<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>Fault Guard Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root {
    --bg-deep: #000000;
    --glass: rgba(20, 20, 25, 0.75);
    --glass-border: rgba(255, 255, 255, 0.15);
    --accent: #0A84FF;
    --good: #30D158;
    --bad: #FF453A;
    --warn: #FFD60A;
    --gemini: #8E54E9;
    --text-main: #FFFFFF;
    --text-sub: rgba(235, 235, 245, 0.7);
    --spring: cubic-bezier(0.175, 0.885, 0.32, 1.1);
    --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 20px);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
  
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: 'Inter', sans-serif;
    overflow: hidden;
    height: 100vh;
  }

  /* Background Image with Overlay */
  .mesh {
    position: fixed; inset: 0; z-index: -1;
    background-image: url('https://images.unsplash.com/photo-1511149755252-35875b273fd6?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTJ8fGxpZ2h0bmluZ3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&q=60&w=600');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .mesh::after {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.85));
    backdrop-filter: blur(2px);
  }

  .app {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: calc(var(--safe-top) + 10px) 20px calc(var(--safe-bottom) + 20px) 20px;
    overflow-y: auto;
    position: relative;
  }

  /* Header */
  header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 25px;
  }
  .brand-group { display: flex; flex-direction: column; }
  .brand h1 { font-size: 22px; margin: 0; letter-spacing: -0.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
  .status-pill {
    margin-top: 4px;
    background: rgba(255,255,255,0.1); padding: 4px 10px; 
    border-radius: 20px; font-size: 11px; font-weight: 600;
    display: inline-flex; gap: 6px; align-items: center; width: fit-content;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.05);
  }

  /* Controls Top Right */
  .header-controls { display: flex; gap: 8px; }

  .icon-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--glass-border);
    width: 36px; height: 36px;
    border-radius: 12px;
    color: #fff; display: grid; place-items: center;
    cursor: pointer;
    backdrop-filter: blur(5px);
  }

  .ai-btn {
    border: none;
    border-radius: 16px;
    padding: 8px 14px;
    display: flex; align-items: center; gap: 6px;
    color: #000;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: transform 0.2s var(--spring);
  }
  .ai-btn:active { transform: scale(0.95); }
  
  .btn-diagnose {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    box-shadow: 0 4px 15px rgba(0, 242, 254, 0.3);
  }
  
  .btn-report {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
  }
  
  .btn-cam {
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    box-shadow: 0 4px 15px rgba(253, 160, 133, 0.3);
    color: #333;
  }

  /* Grid & Cards */
  .grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;
  }
  .card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 16px;
    position: relative;
    transition: transform 0.2s var(--spring);
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }
  .card:active { transform: scale(0.95); }
  .icon-box {
    width: 38px; height: 38px; border-radius: 10px;
    background: rgba(255,255,255,0.08); display: grid; place-items: center;
    font-size: 16px; margin-bottom: 10px; color: var(--text-sub);
  }
  .card-label { font-size: 12px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
  .card-val { font-size: 28px; font-weight: 700; margin-top: 4px; letter-spacing: -1px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .unit { font-size: 14px; color: var(--text-sub); margin-left: 2px; font-weight: 500; }

  /* Dynamic Card Colors */
  .c-vol.active .icon-box { color: var(--accent); background: rgba(10,132,255,0.15); }
  .c-cur.active .icon-box { color: var(--good); background: rgba(48,209,88,0.15); }
  .c-tmp.active .icon-box { color: var(--warn); background: rgba(255,214,10,0.15); }
  .c-lek.active .icon-box { color: var(--bad); background: rgba(255,69,58,0.15); }
  .card.fault { border-color: var(--bad); box-shadow: 0 0 20px rgba(255, 69, 58, 0.4); }
  .tap-hint { position: absolute; top: 16px; right: 16px; font-size: 10px; color: var(--text-sub); opacity: 0.5; }

  /* Hazard Button */
  .hazard-container { margin-top: auto; display: flex; justify-content: center; padding: 10px 0; }
  .emer-btn {
    position: relative; width: 100%; max-width: 320px; height: 80px;
    border-radius: 20px; background: rgba(28, 28, 30, 0.95); border: 1px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center; gap: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6); overflow: hidden;
    transition: all 0.3s var(--spring); cursor: pointer;
  }
  .emer-btn::before {
    content: ''; position: absolute; inset: 0; border-radius: 20px; padding: 3px;
    background: repeating-linear-gradient(45deg, #333, #333 10px, #444 10px, #444 20px);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude; opacity: 0.5;
  }
  .emer-icon {
    width: 40px; height: 40px; border-radius: 50%; background: #2c2c2e; color: #fff;
    display: grid; place-items: center; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.3s;
  }
  .emer-text { text-align: left; }
  .emer-lbl { font-size: 11px; color: #888; letter-spacing: 1px; text-transform: uppercase; }
  .emer-status { font-size: 18px; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
  .emer-btn:active { transform: scale(0.94); }
  .emer-btn.tripped { background: linear-gradient(135deg, #500000, #8b0000); box-shadow: 0 0 30px rgba(255, 69, 58, 0.4); animation: shake 0.5s ease-in-out; }
  .emer-btn.tripped::before { background: repeating-linear-gradient(45deg, #ffcc00, #ffcc00 10px, #000 10px, #000 20px); opacity: 1; }
  .emer-btn.tripped .emer-icon { background: #fff; color: #b00; animation: pulse-fast 1s infinite; }
  .emer-btn.tripped .emer-status { color: #ffaaaa; }
  .emer-btn.armed .emer-icon { color: var(--good); text-shadow: 0 0 10px var(--good); }

  /* Modals */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 999;
    background: rgba(0,0,0,0.01); display: none;
    align-items: flex-end; justify-content: center;
  }
  .modal-overlay.open { display: flex; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
  .modal-card {
    width: 100%; height: 65vh; background: rgba(20, 20, 25, 0.95);
    backdrop-filter: blur(30px) saturate(180%);
    border-top-left-radius: 32px; border-top-right-radius: 32px;
    border-top: 1px solid var(--glass-border);
    box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
    padding: 24px; display: flex; flex-direction: column;
    transform: translateY(100%); transition: transform 0.4s var(--spring);
  }
  .modal-overlay.open .modal-card { transform: translateY(0); }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .modal-title { font-size: 20px; font-weight: 700; }
  .close-btn { 
    background: rgba(255,255,255,0.1); border: none; color: #fff; 
    width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display:grid; place-items: center;
  }

  /* Settings Input */
  .input-group { margin-bottom: 15px; }
  .input-label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 8px; }
  .api-input {
    width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
    padding: 12px; border-radius: 12px; color: #fff; font-family: monospace; font-size: 14px;
  }
  .save-btn {
    width: 100%; background: var(--accent); color: white; border: none; padding: 14px;
    border-radius: 16px; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px;
  }

  /* AI Response */
  .ai-response-area { flex: 1; overflow-y: auto; font-size: 15px; line-height: 1.6; color: #eee; padding-right: 5px; }
  .ai-response-area h3 { color: #00f2fe; margin-top: 0; }
  .ai-response-area strong { color: #fff; }
  .loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-sub); }
  .spinner {
    width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: #00f2fe;
    border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }
  canvas { width: 100% !important; height: 100% !important; }
</style>
</head>
<body>

<div class="mesh"></div>

<!-- HIDDEN FILE INPUT FOR CAMERA -->
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleImageUpload(event)">

<div class="app">
  <header>
    <div class="brand-group">
      <div class="brand">
        <h1>Fault Guard</h1>
      </div>
      <div id="sys" class="status-pill" style="color:var(--good)">
        <i class="fas fa-shield-alt"></i> System Normal
      </div>
    </div>
    
    <div class="header-controls">
      <button class="icon-btn" onclick="openSettings()">
        <i class="fas fa-cog"></i>
      </button>
      <!-- NEW CAMERA BUTTON -->
      <button class="ai-btn btn-cam" onclick="document.getElementById('cameraInput').click()">
        <i class="fas fa-camera"></i> Inspect
      </button>
      <button class="ai-btn btn-report" onclick="generateReport()">
        <i class="fas fa-file-invoice"></i> Report
      </button>
      <button class="ai-btn btn-diagnose" onclick="diagnoseSystem()">
        <i class="fas fa-sparkles"></i> Diagnose
      </button>
    </div>
  </header>

  <div class="grid">
    <div id="cVol" class="card c-vol active" onclick="openChart('vol')">
      <div class="tap-hint"><i class="fas fa-chart-line"></i></div>
      <div class="icon-box"><i class="fas fa-bolt"></i></div>
      <div class="card-label">Line Voltage</div>
      <div class="card-val"><span id="vVol">0.0</span><span class="unit">V</span></div>
    </div>
    <div id="cCur" class="card c-cur active" onclick="openChart('cur')">
      <div class="tap-hint"><i class="fas fa-chart-line"></i></div>
      <div class="icon-box"><i class="fas fa-wave-square"></i></div>
      <div class="card-label">Current</div>
      <div class="card-val"><span id="vCur">0.00</span><span class="unit">A</span></div>
    </div>
    <div id="cTmp" class="card c-tmp active" onclick="openChart('tmp')">
      <div class="tap-hint"><i class="fas fa-chart-line"></i></div>
      <div class="icon-box"><i class="fas fa-temperature-high"></i></div>
      <div class="card-label">Core Temp</div>
      <div class="card-val"><span id="vTmp">0.0</span><span class="unit">°C</span></div>
    </div>
    <div id="cLek" class="card c-lek active" onclick="openChart('lek')">
      <div class="tap-hint"><i class="fas fa-chart-line"></i></div>
      <div class="icon-box"><i class="fas fa-droplet"></i></div>
      <div class="card-label">Leakage</div>
      <div class="card-val"><span id="vLek">0.00</span><span class="unit">A</span></div>
    </div>
  </div>

  <div class="hazard-container">
    <button id="btnEmer" class="emer-btn armed">
      <div class="emer-icon"><i class="fas fa-power-off"></i></div>
      <div class="emer-text">
        <div class="emer-lbl">System Relay</div>
        <div class="emer-status" id="txtRelay">ARMED</div>
      </div>
    </button>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal-overlay" onclick="closeModals(event)">
  <div class="modal-card" onclick="event.stopPropagation()" style="height: auto; min-height: 40vh;">
    <div class="modal-header">
      <div class="modal-title">Settings</div>
      <button class="close-btn" onclick="closeModals()"><i class="fas fa-times"></i></button>
    </div>
    <div class="input-group">
      <label class="input-label">Gemini API Key</label>
      <input type="password" id="apiKeyInput" class="api-input" placeholder="Enter key to override default">
      <div id="keyStatus" style="font-size: 11px; color: var(--good); margin-top: 5px;">
        <i class="fas fa-check-circle"></i> Using embedded default key.
      </div>
    </div>
    <button class="save-btn" onclick="saveSettings()">Save Override Key</button>
    <button class="save-btn" onclick="clearSettings()" style="background:var(--glass-border); margin-top:10px;">Reset to Default</button>
  </div>
</div>

<!-- CHART MODAL -->
<div id="chartModal" class="modal-overlay" onclick="closeModals(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">History</div>
      <button class="close-btn" onclick="closeModals()"><i class="fas fa-times"></i></button>
    </div>
    <div style="flex:1; position: relative; width:100%;">
      <canvas id="chartMain"></canvas>
    </div>
  </div>
</div>

<!-- AI MODAL (Shared for Diagnose & Report) -->
<div id="aiModal" class="modal-overlay" onclick="closeModals(event)">
  <div class="modal-card" onclick="event.stopPropagation()" style="height: 75vh;">
    <div class="modal-header">
      <div class="modal-title" style="display:flex; align-items:center; gap:10px;">
        <i class="fas fa-robot" style="color:#00f2fe" id="aiIcon"></i> 
        <span id="aiTitle">AI Assistant</span>
      </div>
      <button class="close-btn" onclick="closeModals()"><i class="fas fa-times"></i></button>
    </div>
    <div id="aiLoading" class="loading-spinner">
      <div class="spinner"></div>
      <div id="aiLoadingText">Analyzing data...</div>
    </div>
    <div id="aiContent" class="ai-response-area" style="display:none;"></div>
  </div>
</div>

<script>
/* --- Init Firebase --- */
// REVERTED to your original Database URL
const firebaseConfig = { 
  databaseURL: "https://ucfd-31619-default-rtdb.asia-southeast1.firebasedatabase.app/" 
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const TH = { vol: 10.5, cur: 2.8, tmp: 60.0, lek: 0.1 };

/* --- UI Elements --- */
const ui = {
  v: { el: document.getElementById('vVol'), card: document.getElementById('cVol') },
  c: { el: document.getElementById('vCur'), card: document.getElementById('cCur') },
  t: { el: document.getElementById('vTmp'), card: document.getElementById('cTmp') },
  l: { el: document.getElementById('vLek'), card: document.getElementById('cLek') },
  sys: document.getElementById('sys'),
  relay: { btn: document.getElementById('btnEmer'), txt: document.getElementById('txtRelay') }
};

/* --- API Key Management (PERMANENT FIX) --- */
const HARDCODED_KEY = "AIzaSyDmmEqPcvJIGQrRYOIV_X8rY8NHRGbUVNY"; 

function getApiKey() {
  let key = localStorage.getItem('gemini_api_key');
  if (!key || key.trim() === "") {
    key = HARDCODED_KEY;
  }
  return key;
}

function openSettings() {
  const customKey = localStorage.getItem('gemini_api_key') || '';
  document.getElementById('apiKeyInput').value = customKey;
  
  const statusEl = document.getElementById('keyStatus');
  if(customKey) {
    statusEl.innerHTML = '<i class="fas fa-exclamation-circle" style="color:var(--warn)"></i> Using custom override key.';
  } else {
    statusEl.innerHTML = '<i class="fas fa-check-circle" style="color:var(--good)"></i> Using embedded default key.';
  }
  
  document.getElementById('settingsModal').classList.add('open');
}

function saveSettings() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if(key) {
    localStorage.setItem('gemini_api_key', key);
    alert('Override Key Saved!');
  } else {
    alert('Please enter a key to override, or use Reset.');
  }
  closeModals();
}

function clearSettings() {
  localStorage.removeItem('gemini_api_key');
  document.getElementById('apiKeyInput').value = '';
  alert('Reset to Default Key!');
  closeModals();
}

/* --- Common AI Helper --- */
async function callGemini(payload, loadingMsg, title) {
  const apiKey = getApiKey();
  if(!apiKey) return;

  const modal = document.getElementById('aiModal');
  const loader = document.getElementById('aiLoading');
  const content = document.getElementById('aiContent');
  const titleEl = document.getElementById('aiTitle');
  const loadText = document.getElementById('aiLoadingText');
  
  // UI Setup
  titleEl.textContent = title;
  loadText.textContent = loadingMsg;
  modal.classList.add('open');
  loader.style.display = 'flex';
  content.style.display = 'none';
  content.innerHTML = '';

  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message || "API Error");

    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis returned.";
    content.innerHTML = marked.parse(aiText);
    
    loader.style.display = 'none';
    content.style.display = 'block';

  } catch (error) {
    console.error(error);
    loader.style.display = 'none';
    content.style.display = 'block';
    content.innerHTML = `<p style='color:var(--bad)'><strong>Error:</strong> ${error.message}<br><br>Please check your connection/key.</p>`;
  }
}

/* --- Feature 1: Instant Diagnosis --- */
function diagnoseSystem() {
  const readings = {
    v: ui.v.el.textContent,
    c: ui.c.el.textContent,
    t: ui.t.el.textContent,
    l: ui.l.el.textContent,
    r: ui.relay.txt.textContent
  };

  const prompt = `
    You are an expert electrical engineer. Analyze this LIVE telemetry:
    - Line Voltage: ${readings.v} V (Low < 10.5V)
    - Load Current: ${readings.c} A (High > 2.8A)
    - Temp: ${readings.t} °C (High > 60°C)
    - Leakage: ${readings.l} A (Dangerous > 0.1A)
    - Relay: ${readings.r}

    1. Identify faults.
    2. Explain physical causes.
    3. Recommend immediate actions.
    Keep it concise. Markdown supported.
  `;
  
  callGemini({ contents: [{ parts: [{ text: prompt }] }] }, "Diagnosing system...", "AI Diagnosis");
}

/* --- Feature 2: Smart Session Report --- */
function generateReport() {
  let dataStr = "Time(offset), Voltage, Current, Temp, Leakage\n";
  const len = history.vol.length;
  
  if(len === 0) { alert("Not enough data yet. Wait a few seconds."); return; }

  for(let i = 0; i < len; i++) {
     dataStr += `t-${len-i}, ${history.vol[i]}, ${history.cur[i]}, ${history.tmp[i]}, ${history.lek[i]}\n`;
  }

  const prompt = `
    Generate a formal Maintenance Report based on recent telemetry history (last 50 readings).
    
    Data Log:
    ${dataStr}
    
    Thresholds: Voltage < 10.5, Current > 2.8, Temp > 60, Leakage > 0.1.

    Structure: Executive Summary, Stability Analysis, Load Profile, Safety Recs.
  `;

  callGemini({ contents: [{ parts: [{ text: prompt }] }] }, "Generating report...", "Session Report");
}

/* --- Feature 3: Visual Inspection --- */
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const base64Data = e.target.result.split(',')[1];
    
    const payload = {
      contents: [{
        parts: [
          { text: "Analyze this image of an electrical component/wiring. Look for signs of: 1. Burns/Melting 2. Corrosion 3. Loose/Frayed Wires 4. Improper connections. If it looks normal, say so clearly. Be concise." },
          { inline_data: { mime_type: file.type, data: base64Data } }
        ]
      }]
    };

    callGemini(payload, "Scanning image for faults...", "Visual Inspector");
  };
  reader.readAsDataURL(file);
}

/* --- Charting & History --- */
let mainChartInstance = null;
const ctx = document.getElementById('chartMain').getContext('2d');
const history = { vol: [], cur: [], tmp: [], lek: [] };
const labels = { vol: [], cur: [], tmp: [], lek: [] };
const MAX_PTS = 50;

function updateHist(key, val) {
  const now = new Date();
  history[key].push(val);
  labels[key].push(now);
  if(history[key].length > MAX_PTS) { history[key].shift(); labels[key].shift(); }
}

/* --- Modal Logic --- */
let currentChartType = null;
const modals = document.querySelectorAll('.modal-overlay');

function openChart(type) {
  currentChartType = type;
  const title = document.getElementById('modalTitle');
  let color = '#fff';
  
  if(type === 'vol') { title.textContent = 'Line Voltage'; color = '#0A84FF'; }
  if(type === 'cur') { title.textContent = 'Load Current'; color = '#30D158'; }
  if(type === 'tmp') { title.textContent = 'Core Temp'; color = '#FFD60A'; }
  if(type === 'lek') { title.textContent = 'Leakage Current'; color = '#FF453A'; }

  if(mainChartInstance) mainChartInstance.destroy();
  
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, color);
  gradient.addColorStop(1, 'rgba(0,0,0,0)');

  mainChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels[type],
      datasets: [{
        data: history[type],
        borderColor: color,
        backgroundColor: gradient,
        fill: true,
        pointRadius: 2,
        borderWidth: 3,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'mm:ss' } }, grid: { display: false }, ticks: { color: '#666' } },
        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#666' } }
      }
    }
  });

  document.getElementById('chartModal').classList.add('open');
}

function closeModals(e) {
  modals.forEach(m => m.classList.remove('open'));
  currentChartType = null;
  document.getElementById('cameraInput').value = ''; 
}

/* --- Data Processing & Relay Lock --- */
let manualLockActive = false;
let manualLockTimer = null;

function processData(data) {
  // If data is null or flattened, normalize it
  const v = Number(data.voltage ?? data.Voltage ?? data.V ?? 0);
  const c = Number(data.current ?? data.Current ?? data.I ?? 0);
  const t = Number(data.temperature ?? data.Temperature ?? data.temp ?? 0);
  const l = Number(data.leakage_current ?? data.leakage ?? data.Leakage ?? 0);

  ui.v.el.textContent = v.toFixed(1);
  ui.c.el.textContent = c.toFixed(2);
  ui.t.el.textContent = t.toFixed(1);
  ui.l.el.textContent = l.toFixed(3);

  checkFault(ui.v.card, v < TH.vol);
  checkFault(ui.c.card, c > TH.cur);
  checkFault(ui.t.card, t > TH.tmp);
  checkFault(ui.l.card, l > TH.lek);

  const anyFault = (v < TH.vol) || (c > TH.cur) || (t > TH.tmp) || (l > TH.lek);
  if(anyFault) {
    ui.sys.innerHTML = '<i class="fas fa-exclamation-triangle"></i> FAULT';
    ui.sys.style.color = 'var(--bad)';
  } else {
    ui.sys.innerHTML = '<i class="fas fa-shield-alt"></i> SECURE';
    ui.sys.style.color = 'var(--good)';
  }

  updateHist('vol', v); updateHist('cur', c); updateHist('tmp', t); updateHist('lek', l);

  if(mainChartInstance && currentChartType) {
    mainChartInstance.data.labels = labels[currentChartType];
    mainChartInstance.data.datasets[0].data = history[currentChartType];
    mainChartInstance.update('none');
  }

  // --- RELAY UPDATE LOGIC ---
  if(!manualLockActive) {
      // Check multiple possible key names for relay status
      const rStat = data.relay_status ?? data.relay ?? data.Relay ?? 'CLOSED';
      const isOpen = (String(rStat).toUpperCase() === 'OPEN' || rStat == 1 || rStat === '1');
      setRelayVisuals(isOpen);
  }
}

function checkFault(card, isFault) {
  if(isFault) card.classList.add('fault');
  else card.classList.remove('fault');
}

function setRelayVisuals(isOpen) {
  const btn = ui.relay.btn;
  const txt = ui.relay.txt;
  if(isOpen) {
    btn.className = 'emer-btn tripped';
    txt.textContent = 'TRIPPED';
    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
  } else {
    btn.className = 'emer-btn armed';
    txt.textContent = 'ARMED';
  }
}

// RELAY BUTTON CLICK HANDLER (UPDATED to match working code logic)
ui.relay.btn.addEventListener('click', () => {
  const isTripped = ui.relay.btn.classList.contains('tripped');
  const nextState = !isTripped; // If currently Tripped (OPEN), next is ARMED (CLOSED)
  const statusStr = nextState ? 'OPEN' : 'CLOSED';
  
  // 1. Optimistic UI Update
  setRelayVisuals(nextState);
  
  // 2. Lock UI update from incoming sensor data temporarily
  manualLockActive = true;
  if(manualLockTimer) clearTimeout(manualLockTimer);
  manualLockTimer = setTimeout(() => { manualLockActive = false; }, 6000);

  // 3. Dual Write (Matches working code structure)
  // Write to 'manual_controls/relay_status' AND 'relay'
  const updates = {};
  updates['manual_controls/relay_status'] = statusStr;
  updates['relay'] = nextState ? 1 : 0;

  db.ref().update(updates)
    .then(() => console.log("Write Success"))
    .catch((error) => {
        alert("Write Failed: " + error.message);
        setRelayVisuals(isTripped); // Revert
        manualLockActive = false;
    });
});

// Listener Logic (Robust handling for nested or flat data)
const sensorRef = db.ref('sensor_data');
sensorRef.limitToLast(1).on('child_added', s => { 
  if(s.val()) processData(s.val()); 
});

// Also listen to manual controls directly to keep UI in sync if changed elsewhere
db.ref('manual_controls/relay_status').on('value', s => {
    if(manualLockActive) return; // Don't override if user just clicked
    const val = s.val();
    const isOpen = (String(val).toUpperCase() === 'OPEN');
    setRelayVisuals(isOpen);
});

</script>
</body>
</html>
